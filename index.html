<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêæ Controle de Medica√ß√£o Animal - PWA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #7ed321;
            --warning: #f5a623;
            --danger: #d0021b;
            --info: #50e3c2;
            --light: #f8f9fa;
            --dark: #333;
            --morning: #ff9800;
            --night: #673ab7;
            --success: #27ae60;
            --bg-color: #f5f7fa;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
        }
        
        [data-theme="dark"] {
            --primary: #64b5f6;
            --secondary: #81c784;
            --warning: #ffb74d;
            --danger: #e57373;
            --info: #4db6ac;
            --light: #424242;
            --dark: #f5f5f5;
            --morning: #ff9800;
            --night: #9575cd;
            --success: #66bb6a;
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #424242;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--card-color);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2rem;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .time-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .time-box {
            background: var(--light);
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .current-time {
            background-color: var(--light);
            color: var(--primary);
        }
        
        .cache-indicator {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            min-width: 150px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .cache-meters {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }
        
        .cache-meter {
            background: var(--border-color);
            border-radius: 10px;
            width: 100%;
            height: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .cache-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--info));
            width: 0%;
            transition: width 0.5s;
            border-radius: 10px;
        }
        
        .total-cache-fill {
            background: linear-gradient(90deg, var(--primary), var(--night));
        }
        
        .cache-text {
            font-size: 0.8rem;
            color: var(--text-color);
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .cache-warning {
            color: var(--warning);
            font-weight: bold;
        }
        
        .theme-toggle {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .upcoming-medications {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .upcoming-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .upcoming-item {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .upcoming-item.urgent {
            border-left: 4px solid var(--danger);
            animation: pulse 2s infinite;
        }
        
        .upcoming-item.overdue {
            border-left: 4px solid var(--warning);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(208, 2, 27, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(208, 2, 27, 0); }
            100% { box-shadow: 0 0 0 0 rgba(208, 2, 27, 0); }
        }
        
        .countdown-timer {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: var(--primary);
        }
        
        .overdue-timer {
            color: var(--warning);
        }
        
        .progress-bar-container {
            margin-top: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--info));
            width: 0%;
            transition: width 0.5s;
            border-radius: 5px;
        }
        
        .animal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .animal-card {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .animal-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .animal-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        
        .animal-name {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .animal-weight {
            background: var(--light);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 10px;
            border: 1px solid var(--border-color);
        }
        
        .medication-list {
            margin-top: 15px;
        }
        
        .medication-item {
            background: var(--light);
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .medication-info h4 {
            color: var(--text-color);
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        .medication-details {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .medication-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .medication-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 90px;
            text-align: center;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-done {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-skipped {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-upcoming {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-overdue {
            background-color: #f5a623;
            color: white;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.75rem;
        }
        
        .btn-mark {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-unmark {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-skip {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-edit {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-delete {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-add {
            background-color: var(--success);
            color: white;
        }
        
        .btn-pdf {
            background-color: #f44336;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .calendar-section {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            min-width: 700px;
        }
        
        .calendar-day {
            background: var(--light);
            border-radius: 8px;
            padding: 8px;
            min-height: 120px;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .calendar-day:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px;
            background: var(--light);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .day-pdf-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .day-pdf-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .today {
            background-color: rgba(100, 181, 246, 0.2);
            border: 2px solid var(--primary);
        }
        
        .calendar-medication {
            font-size: 0.65rem;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
        }
        
        .calendar-medication:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--dark);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: normal;
            width: 250px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: left;
            line-height: 1.4;
        }
        
        .medication-morning {
            background-color: rgba(255, 235, 59, 0.3);
            border-left: 2px solid var(--morning);
        }
        
        .medication-night {
            background-color: rgba(103, 58, 183, 0.3);
            border-left: 2px solid var(--night);
        }
        
        .medication-overdue {
            background-color: rgba(245, 166, 35, 0.3);
            border-left: 2px solid var(--warning);
        }
        
        .management-section {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
            background: var(--light);
            color: var(--text-color);
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .animals-list {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .animal-manage-item {
            background: var(--light);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .cache-controls {
            margin-top: 15px;
        }
        
        .notification {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 300px;
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        
        .modal-content {
            background: var(--card-color);
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: var(--text-color);
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .developer-info {
            margin-top: 10px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            display: inline-block;
            border: 1px solid var(--border-color);
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Estilos para a se√ß√£o de hist√≥rico */
        .history-section {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
            flex: 1;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .history-table th {
            background: var(--light);
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .history-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-ok {
            color: var(--success);
            font-weight: bold;
        }
        
        .status-late {
            color: var(--warning);
            font-weight: bold;
        }
        
        .status-administered {
            color: var(--secondary);
            font-weight: bold;
        }
        
        .status-pending {
            color: var(--primary);
            font-weight: bold;
        }
        
        /* Estilos para indicadores */
        .indicators-section {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .indicator-card {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .indicator-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .indicator-label {
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .animal-cards {
                grid-template-columns: 1fr;
            }
            
            .header-top {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            .time-display {
                flex-direction: column;
                gap: 10px;
            }
            
            .cache-indicator {
                min-width: 100%;
            }
            
            .calendar-grid {
                min-width: 100%;
                font-size: 0.8rem;
            }
            
            .calendar-day {
                min-height: 100px;
            }
            
            .calendar-medication:hover::after {
                width: 200px;
                font-size: 0.7rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .animal-name {
                font-size: 1.4rem;
            }
            
            .indicators-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-buttons {
                justify-content: center;
                margin-top: 10px;
            }
            
            .history-table {
                font-size: 0.8rem;
            }
            
            .history-table th,
            .history-table td {
                padding: 8px 5px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            header, .animal-card, .calendar-section, .management-section, .upcoming-medications {
                padding: 15px;
            }
            
            .calendar-grid {
                gap: 5px;
            }
            
            .calendar-day {
                min-height: 90px;
                padding: 5px;
            }
            
            .day-number {
                font-size: 0.8rem;
            }
            
            .calendar-medication {
                font-size: 0.6rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .indicators-grid {
                grid-template-columns: 1fr;
            }
            
            .history-table {
                font-size: 0.7rem;
            }
            
            .history-table th,
            .history-table td {
                padding: 6px 3px;
            }
        }
        
        /* Estilos para o tema escuro */
        body[data-theme="dark"] .status-pending {
            background-color: #5d4037;
            color: #ffcc80;
        }
        
        body[data-theme="dark"] .status-done {
            background-color: #1b5e20;
            color: #a5d6a7;
        }
        
        body[data-theme="dark"] .status-skipped {
            background-color: #b71c1c;
            color: #ef9a9a;
        }
        
        body[data-theme="dark"] .status-upcoming {
            background-color: #004d40;
            color: #80cbc4;
        }
        
        body[data-theme="dark"] .status-overdue {
            background-color: #ff6f00;
            color: #ffe0b2;
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* Utilit√°rios */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
        
        .mb-10 {
            margin-bottom: 10px;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-10 {
            gap: 10px;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 3px;
            display: none;
        }
        
        .input-error {
            border-color: var(--danger) !important;
        }
        
        .data-load-section {
            background: var(--card-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .data-load-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-load-cats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-clear-data {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .history-table-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .history-table-wrapper {
            overflow-x: auto;
        }
        
        .history-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        
        .badge-late {
            background-color: rgba(245, 166, 35, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 166, 35, 0.3);
        }
        
        .badge-on-time {
            background-color: rgba(126, 211, 33, 0.2);
            color: var(--secondary);
            border: 1px solid rgba(126, 211, 33, 0.3);
        }
        
        .badge-administered {
            background-color: rgba(74, 144, 226, 0.2);
            color: var(--primary);
            border: 1px solid rgba(74, 144, 226, 0.3);
        }
        
        .badge-pending {
            background-color: rgba(240, 240, 240, 0.5);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .history-note {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.8;
            font-style: italic;
            margin-top: 5px;
        }
        
        .history-detail-row {
            background: var(--light);
            border-radius: 8px;
            padding: 8px;
            margin-top: 5px;
            font-size: 0.85rem;
        }
        
        .detail-label {
            font-weight: bold;
            color: var(--primary);
        }
        
        .history-actions {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <header>
            <div class="header-top">
                <div>
                    <h1><i class="fas fa-paw"></i> Controle de Medica√ß√£o Animal - PWA</h1>
                    <p>Sistema para gerenciamento de medicamentos para animais (offline-first)</p>
                </div>
                
                <div class="cache-indicator">
                    <div class="cache-text">
                        <span>Cache App:</span>
                        <span id="cache-percentage">0%</span>
                    </div>
                    <div class="cache-meters">
                        <div class="cache-meter">
                            <div class="cache-fill" id="cache-fill"></div>
                        </div>
                        <div class="cache-text">
                            <span>Cache Total:</span>
                            <span id="total-cache-percentage">0%</span>
                        </div>
                        <div class="cache-meter">
                            <div class="cache-fill total-cache-fill" id="total-cache-fill"></div>
                        </div>
                    </div>
                </div>
                
                <div class="header-controls">
                    <button class="btn btn-load-cats btn-small" onclick="loadFrajolaNenemData()">
                        <i class="fas fa-cat"></i> Carregar Frajola e Nen√©m
                    </button>
                    <button class="theme-toggle" id="theme-toggle" title="Alternar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-warning btn-small" onclick="clearAppCache()">
                        <i class="fas fa-trash-alt"></i> Limpar Cache App
                    </button>
                    <button class="btn btn-pdf btn-small" onclick="exportMonthToPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar M√™s
                    </button>
                </div>
            </div>
            
            <div class="time-display">
                <div class="time-box current-time">
                    <i class="fas fa-clock"></i> 
                    <div>
                        <div>Hor√°rio Local: <span id="local-time">--:--</span></div>
                        <div id="current-date" style="font-size: 0.85rem; font-weight: normal;">--/--/----</div>
                    </div>
                </div>
                <div class="time-box">
                    <i class="fas fa-syringe"></i>
                    <div id="next-medication-count">Pr√≥ximas: 0</div>
                </div>
                <div class="time-box" id="overdue-medication-count" style="background-color: rgba(245, 166, 35, 0.2); display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Atrasadas: <span id="overdue-count">0</span></div>
                </div>
            </div>
        </header>
        
        <!-- Se√ß√£o de Carregamento de Dados -->
        <div class="data-load-section">
            <h2><i class="fas fa-database"></i> Carregar Dados Predefinidos</h2>
            <p>Carregue os dados dos seus gatos para come√ßar a usar o sistema imediatamente</p>
            <div class="data-load-buttons">
                <button class="btn btn-load-cats" onclick="loadFrajolaNenemData()">
                    <i class="fas fa-cat"></i> Carregar Frajola e Nen√©m
                </button>
                <button class="btn btn-clear-data" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> Limpar Todos os Dados
                </button>
            </div>
            <div class="history-note" style="margin-top: 15px;">
                <i class="fas fa-info-circle"></i> Os dados dos seus gatos incluem todos os medicamentos e hor√°rios pr√©-configurados
            </div>
        </div>
        
        <!-- Indicadores de Uso e Ader√™ncia -->
        <div class="indicators-section">
            <h2><i class="fas fa-chart-line"></i> Indicadores de Uso e Ader√™ncia</h2>
            <div class="indicators-grid" id="indicators-grid">
                <!-- Preenchido por JavaScript -->
            </div>
        </div>
        
        <!-- Pr√≥ximas Medica√ß√µes com Timer -->
        <div class="upcoming-medications">
            <h2><i class="fas fa-hourglass-half"></i> Pr√≥ximas Medica√ß√µes</h2>
            <div class="upcoming-grid" id="upcoming-medications-list">
                <!-- Preenchido por JavaScript -->
            </div>
        </div>
        
        <!-- Cards dos Animais -->
        <div class="animal-cards" id="animal-cards-container">
            <!-- Preenchido por JavaScript -->
        </div>
        
        <!-- Hist√≥rico de Medica√ß√µes -->
        <div class="history-section">
            <h2><i class="fas fa-history"></i> Hist√≥rico de Medica√ß√µes</h2>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openHistoryTab(event, 'history-all')">Todos</button>
                    <button class="tab-button" onclick="openHistoryTab(event, 'history-animal')">Por Animal</button>
                    <button class="tab-button" onclick="openHistoryTab(event, 'history-medication')">Por Medicamento</button>
                    <button class="tab-button" onclick="openHistoryTab(event, 'history-detailed')">Detalhado</button>
                </div>
                
                <!-- Tab Todos -->
                <div id="history-all" class="tab-content active">
                    <div class="history-filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="history-animal-select">Animal:</label>
                                <select id="history-animal-select">
                                    <option value="all">Todos os animais</option>
                                    <!-- Preenchido por JavaScript -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="history-medication-select">Medicamento:</label>
                                <select id="history-medication-select">
                                    <option value="all">Todos os medicamentos</option>
                                    <!-- Preenchido por JavaScript -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="history-period-select">Per√≠odo:</label>
                                <select id="history-period-select">
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="30" selected>√öltimos 30 dias</option>
                                    <option value="90">√öltimos 90 dias</option>
                                    <option value="365">√öltimo ano</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div class="filter-group" id="custom-date-range" style="display: none;">
                                <div style="display: flex; gap: 10px;">
                                    <div>
                                        <label for="custom-start-date">In√≠cio:</label>
                                        <input type="date" id="custom-start-date" style="width: 140px;">
                                    </div>
                                    <div>
                                        <label for="custom-end-date">Fim:</label>
                                        <input type="date" id="custom-end-date" style="width: 140px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-edit" onclick="updateHistoryTable()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <button class="btn btn-pdf" onclick="exportHistoryToPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="history-table-container">
                        <div class="history-table-wrapper">
                            <table class="history-table" id="history-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Hora</th>
                                        <th>Animal</th>
                                        <th>Medicamento</th>
                                        <th>Dosagem</th>
                                        <th>Hor√°rio Previsto</th>
                                        <th>Hor√°rio Real</th>
                                        <th>Status</th>
                                        <th>Atraso</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Por Animal -->
                <div id="history-animal" class="tab-content">
                    <div class="history-filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="history-animal-specific-select">Animal:</label>
                                <select id="history-animal-specific-select">
                                    <!-- Preenchido por JavaScript -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="history-animal-period">Per√≠odo:</label>
                                <select id="history-animal-period">
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="30" selected>√öltimos 30 dias</option>
                                    <option value="90">√öltimos 90 dias</option>
                                    <option value="365">√öltimo ano</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-edit" onclick="updateAnimalHistory()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <button class="btn btn-pdf" onclick="exportAnimalHistoryPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="history-table-container">
                        <div class="history-table-wrapper">
                            <table class="history-table" id="animal-history-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Hora</th>
                                        <th>Medicamento</th>
                                        <th>Dosagem</th>
                                        <th>Hor√°rio</th>
                                        <th>Status</th>
                                        <th>Atraso</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="animal-history-body">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Por Medicamento -->
                <div id="history-medication" class="tab-content">
                    <div class="history-filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="history-medication-specific-select">Medicamento:</label>
                                <select id="history-medication-specific-select">
                                    <!-- Preenchido por JavaScript -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="history-medication-period">Per√≠odo:</label>
                                <select id="history-medication-period">
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="30" selected>√öltimos 30 dias</option>
                                    <option value="90">√öltimos 90 dias</option>
                                    <option value="365">√öltimo ano</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-edit" onclick="updateMedicationHistory()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <button class="btn btn-pdf" onclick="exportMedicationHistoryPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="history-table-container">
                        <div class="history-table-wrapper">
                            <table class="history-table" id="medication-history-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Hora</th>
                                        <th>Animal</th>
                                        <th>Dosagem</th>
                                        <th>Hor√°rio</th>
                                        <th>Status</th>
                                        <th>Atraso</th>
                                        <th>Detalhes</th>
                                    </tr>
                                </thead>
                                <tbody id="medication-history-body">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Detalhado -->
                <div id="history-detailed" class="tab-content">
                    <div class="history-filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="history-detailed-animal">Animal:</label>
                                <select id="history-detailed-animal">
                                    <option value="all">Todos os animais</option>
                                    <!-- Preenchido por JavaScript -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="history-detailed-period">Per√≠odo:</label>
                                <select id="history-detailed-period">
                                    <option value="today">Hoje</option>
                                    <option value="yesterday">Ontem</option>
                                    <option value="week" selected>Esta semana</option>
                                    <option value="month">Este m√™s</option>
                                    <option value="last30">√öltimos 30 dias</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="history-detailed-status">Status:</label>
                                <select id="history-detailed-status">
                                    <option value="all">Todos</option>
                                    <option value="administered">Administradas</option>
                                    <option value="pending">Pendentes</option>
                                    <option value="late">Atrasadas</option>
                                    <option value="on-time">No prazo</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-buttons">
                            <button class="btn btn-edit" onclick="updateDetailedHistory()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                            <button class="btn btn-pdf" onclick="exportDetailedHistoryPDF()">
                                <i class="fas fa-file-pdf"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div id="detailed-history-container">
                        <!-- Preenchido por JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calend√°rio -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h2><i class="fas fa-calendar"></i> Calend√°rio de Medica√ß√µes</h2>
                <div class="calendar-nav">
                    <button class="btn btn-edit" onclick="changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <h3 id="current-month">M√™s Atual</h3>
                    <button class="btn btn-edit" onclick="changeMonth(1)">
                        Pr√≥ximo <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="btn btn-pdf" onclick="exportMonthRangeToPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar Per√≠odo
                    </button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendar-days-header">
                <!-- Cabe√ßalhos dos dias -->
            </div>
            <div class="calendar-grid" id="calendar-days">
                <!-- Dias ser√£o gerados por JavaScript -->
            </div>
        </div>
        
        <!-- Modal para Detalhes do Dia -->
        <div class="modal" id="dayModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalDayTitle">Detalhes do Dia</h3>
                    <button class="close-modal" onclick="closeDayModal()">&times;</button>
                </div>
                <div id="modalDayContent">
                    <!-- Conte√∫do do modal ser√° preenchido por JavaScript -->
                </div>
                <div class="modal-actions">
                    <button class="btn btn-pdf" onclick="exportDayToPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF do Dia
                    </button>
                    <button class="btn btn-edit" onclick="closeDayModal()">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal para Exporta√ß√£o de Per√≠odo -->
        <div class="modal" id="exportModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Exportar Per√≠odo</h3>
                    <button class="close-modal" onclick="closeExportModal()">&times;</button>
                </div>
                <div id="exportModalContent">
                    <div class="form-group">
                        <label for="export-start-date">Data Inicial:</label>
                        <input type="date" id="export-start-date">
                    </div>
                    <div class="form-group">
                        <label for="export-end-date">Data Final:</label>
                        <input type="date" id="export-end-date">
                    </div>
                    <div class="form-group">
                        <label for="export-animal-select">Animal (opcional):</label>
                        <select id="export-animal-select">
                            <option value="all">Todos os animais</option>
                            <!-- Preenchido por JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-pdf" onclick="exportSelectedRangeToPDF()">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                    <button class="btn btn-edit" onclick="closeExportModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Gerenciamento -->
        <div class="management-section">
            <h2><i class="fas fa-cogs"></i> Gerenciamento do Sistema</h2>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'tab-animals')">Animais</button>
                    <button class="tab-button" onclick="openTab(event, 'tab-medications')">Medicamentos</button>
                    <button class="tab-button" onclick="openTab(event, 'tab-cache')">Cache</button>
                </div>
                
                <!-- Tab Animais -->
                <div id="tab-animals" class="tab-content active">
                    <div class="form-grid">
                        <div>
                            <h3><i class="fas fa-plus-circle"></i> Adicionar Novo Animal</h3>
                            <div class="form-group">
                                <label for="new-animal-name">Nome do Animal:</label>
                                <input type="text" id="new-animal-name" placeholder="Ex: Tom" maxlength="30">
                                <div class="error-message" id="animal-name-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="new-animal-weight">Peso (kg):</label>
                                <input type="number" id="new-animal-weight" placeholder="Ex: 5.2" min="0.1" max="200" step="0.1">
                                <div class="error-message" id="animal-weight-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="new-animal-breed">Ra√ßa:</label>
                                <input type="text" id="new-animal-breed" placeholder="Ex: SRD" maxlength="30">
                            </div>
                            <div class="form-group">
                                <label for="new-animal-icon">√çcone:</label>
                                <select id="new-animal-icon">
                                    <option value="üê±">üê± Gato</option>
                                    <option value="üê∂">üê∂ Cachorro</option>
                                    <option value="üê∞">üê∞ Coelho</option>
                                    <option value="üêπ">üêπ Hamster</option>
                                    <option value="üê¶">üê¶ P√°ssaro</option>
                                    <option value="üê¢">üê¢ Tartaruga</option>
                                </select>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-add" onclick="addNewAnimal()">
                                    <i class="fas fa-plus"></i> Adicionar Animal
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3><i class="fas fa-list"></i> Animais Cadastrados</h3>
                            <div class="animals-list" id="animals-management-list">
                                <!-- Preenchido por JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Medicamentos -->
                <div id="tab-medications" class="tab-content">
                    <div class="form-grid">
                        <div>
                            <h3><i class="fas fa-pills"></i> Adicionar Medicamento</h3>
                            <div class="form-group">
                                <label for="med-animal-select">Animal:</label>
                                <select id="med-animal-select">
                                    <!-- Preenchido por JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-med-name">Nome do Medicamento:</label>
                                <input type="text" id="new-med-name" placeholder="Ex: Antibi√≥tico" maxlength="50">
                                <div class="error-message" id="med-name-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="new-med-dosage">Dosagem:</label>
                                <input type="text" id="new-med-dosage" placeholder="Ex: 1 comprimido" maxlength="30">
                                <div class="error-message" id="med-dosage-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="new-med-frequency">Frequ√™ncia:</label>
                                <select id="new-med-frequency" onchange="toggleCustomFrequency()">
                                    <option value="daily">1x ao dia</option>
                                    <option value="12h">12/12h</option>
                                    <option value="48h">A cada 48h</option>
                                    <option value="weekly">1x por semana</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            
                            <!-- Campos para frequ√™ncia personalizada -->
                            <div id="custom-frequency-fields" class="hidden">
                                <div class="form-group">
                                    <label for="custom-frequency-value">Intervalo (horas):</label>
                                    <input type="number" id="custom-frequency-value" min="1" max="720" value="24">
                                    <div class="error-message" id="custom-frequency-error"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-med-schedule">Hor√°rio:</label>
                                <select id="new-med-schedule">
                                    <option value="morning">Manh√£ (07:30-08:00)</option>
                                    <option value="night">Noite (19:30-21:00)</option>
                                    <option value="both">Manh√£ e Noite</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-med-start-date">Data de In√≠cio:</label>
                                <input type="date" id="new-med-start-date">
                            </div>
                            <div class="form-group">
                                <label for="new-med-duration-type">Dura√ß√£o:</label>
                                <select id="new-med-duration-type" onchange="toggleDurationFields()">
                                    <option value="days">N√∫mero de dias</option>
                                    <option value="end_date">Data de t√©rmino</option>
                                    <option value="continuous">Cont√≠nuo</option>
                                </select>
                            </div>
                            <div class="form-group" id="duration-days-container">
                                <label for="new-med-duration-days">N√∫mero de dias:</label>
                                <input type="number" id="new-med-duration-days" min="1" max="365" value="7">
                                <div class="error-message" id="duration-days-error"></div>
                            </div>
                            <div class="form-group hidden" id="end-date-container">
                                <label for="new-med-end-date">Data de T√©rmino:</label>
                                <input type="date" id="new-med-end-date">
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-add" onclick="addNewMedication()">
                                    <i class="fas fa-plus"></i> Adicionar Medicamento
                                </button>
                                <button class="btn btn-edit" onclick="loadMedicationFromCache()">
                                    <i class="fas fa-database"></i> Usar Cache
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3><i class="fas fa-prescription"></i> Medicamentos Pr√©-cadastrados</h3>
                            <div class="controls" style="margin-bottom: 15px;">
                                <button class="btn btn-edit btn-small" onclick="addPreloadedMedication('frajo la', 'Vetmax Plus', '¬Ω comprimido', 'daily', 'morning', 3)">
                                    <i class="fas fa-plus"></i> Vetmax Plus (Frajola)
                                </button>
                                <button class="btn btn-edit btn-small" onclick="addPreloadedMedication('frajo la', 'Omegablue Esqualeno', '1 c√°psula', '48h', 'night', null)">
                                    <i class="fas fa-plus"></i> Omegablue (Frajola)
                                </button>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.8; margin-top: 10px;">
                                Clique para adicionar medicamentos pr√©-cadastrados
                            </div>
                            
                            <div class="cache-controls" style="margin-top: 20px;">
                                <h4><i class="fas fa-database"></i> Cache de Medicamentos</h4>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                    <button class="btn btn-add btn-small" onclick="loadMedicationsFromJSON()">
                                        <i class="fas fa-vial"></i> Carregar Todos Exemplos
                                    </button>
                                    <button class="btn btn-edit btn-small" onclick="saveMedicationsToCache()">
                                        <i class="fas fa-save"></i> Salvar em Cache
                                    </button>
                                    <button class="btn btn-warning btn-small" onclick="clearMedicationsCache()">
                                        <i class="fas fa-trash"></i> Limpar Cache
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Cache -->
                <div id="tab-cache" class="tab-content">
                    <h3><i class="fas fa-database"></i> Controle de Cache</h3>
                    <div class="controls">
                        <button class="btn btn-warning" onclick="clearAppCache()">
                            <i class="fas fa-trash-alt"></i> Limpar Cache do App
                        </button>
                        <button class="btn btn-edit" onclick="exportData()">
                            <i class="fas fa-download"></i> Exportar Dados
                        </button>
                        <button class="btn btn-edit" onclick="importData()">
                            <i class="fas fa-upload"></i> Importar Dados
                        </button>
                        <button class="btn btn-danger" onclick="resetAllData()">
                            <i class="fas fa-exclamation-triangle"></i> Resetar Tudo
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Status PWA</h4>
                        <div id="pwa-status" style="margin-top: 10px; padding: 10px; background: var(--light); border-radius: 10px;">
                            Verificando status...
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Informa√ß√µes de Armazenamento</h4>
                        <div id="storage-info" style="margin-top: 10px; padding: 10px; background: var(--light); border-radius: 10px; font-size: 0.9rem;">
                            Calculando...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notifica√ß√£o -->
        <div class="notification" id="notification">
            Medica√ß√£o registrada com sucesso!
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Sistema de controle de medica√ß√£o animal | Desenvolvido por Marcos Guimar√£es Duailibi Filho</p>
            <div class="developer-info">
                <p><i class="fas fa-phone"></i> Contato: +55 (95) 98111-4983</p>
                <p><i class="fas fa-envelope"></i> Email: marcosduailibi12345@hotmail.com</p>
            </div>
            <p style="margin-top: 15px;">¬© 2025 - Todos os direitos reservados.</p>
            <p style="font-size: 0.7rem; opacity: 0.6;">Vers√£o PWA Offline-First</p>
        </div>
    </div>

    <script>
        // Sistema de cache avan√ßado
        class CacheManager {
            constructor() {
                this.appCacheKey = 'vetmed_app_data';
                this.medicationsCacheKey = 'vetmed_medications_cache';
                this.settingsCacheKey = 'vetmed_settings';
            }
            
            getAppCacheSize() {
                const appData = localStorage.getItem(this.appCacheKey);
                return appData ? appData.length * 2 : 0; // em bytes
            }
            
            getMedicationsCacheSize() {
                const medData = localStorage.getItem(this.medicationsCacheKey);
                return medData ? medData.length * 2 : 0;
            }
            
            getTotalCacheSize() {
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length * 2;
                    }
                }
                return total;
            }
            
            getAppCachePercentage() {
                const appSize = this.getAppCacheSize();
                const totalLimit = 5 * 1024 * 1024; // 5MB em bytes
                return (appSize / totalLimit) * 100;
            }
            
            getTotalCachePercentage() {
                const totalSize = this.getTotalCacheSize();
                const totalLimit = 5 * 1024 * 1024; // 5MB em bytes
                return (totalSize / totalLimit) * 100;
            }
            
            clearAppCache() {
                localStorage.removeItem(this.appCacheKey);
                localStorage.removeItem(this.settingsCacheKey);
                this.updateCacheDisplay();
                showNotification('Cache da aplica√ß√£o limpo com sucesso!');
            }
            
            clearMedicationsCache() {
                localStorage.removeItem(this.medicationsCacheKey);
                this.updateCacheDisplay();
                showNotification('Cache de medicamentos limpo com sucesso!', 'info');
            }
            
            saveMedicationsToCache(medications) {
                try {
                    localStorage.setItem(this.medicationsCacheKey, JSON.stringify(medications));
                    this.updateCacheDisplay();
                    return true;
                } catch (e) {
                    console.error('Erro ao salvar medicamentos no cache:', e);
                    return false;
                }
            }
            
            getMedicationsFromCache() {
                try {
                    const cached = localStorage.getItem(this.medicationsCacheKey);
                    return cached ? JSON.parse(cached) : null;
                } catch (e) {
                    console.error('Erro ao carregar medicamentos do cache:', e);
                    return null;
                }
            }
            
            updateCacheDisplay() {
                const appPercentage = this.getAppCachePercentage();
                const totalPercentage = this.getTotalCachePercentage();
                
                const fillElement = document.getElementById('cache-fill');
                const totalFillElement = document.getElementById('total-cache-fill');
                const appTextElement = document.getElementById('cache-percentage');
                const totalTextElement = document.getElementById('total-cache-percentage');
                
                fillElement.style.width = `${Math.min(100, appPercentage)}%`;
                totalFillElement.style.width = `${Math.min(100, totalPercentage)}%`;
                appTextElement.textContent = `${appPercentage.toFixed(1)}%`;
                totalTextElement.textContent = `${totalPercentage.toFixed(1)}%`;
                
                // Altera a cor conforme o uso
                if (appPercentage > 80) {
                    fillElement.style.background = 'linear-gradient(90deg, #d0021b, #ff0000)';
                } else if (appPercentage > 50) {
                    fillElement.style.background = 'linear-gradient(90deg, #f5a623, #d0021b)';
                } else if (appPercentage > 25) {
                    fillElement.style.background = 'linear-gradient(90deg, #f5a623, #f5a623)';
                } else {
                    fillElement.style.background = 'linear-gradient(90deg, var(--secondary), var(--info))';
                }
                
                // Atualiza informa√ß√µes de armazenamento
                this.updateStorageInfo();
            }
            
            updateStorageInfo() {
                const storageInfo = document.getElementById('storage-info');
                if (!storageInfo) return;
                
                const appSize = this.getAppCacheSize();
                const medSize = this.getMedicationsCacheSize();
                const totalSize = this.getTotalCacheSize();
                const totalLimit = 5 * 1024 * 1024; // 5MB
                const freeSpace = totalLimit - totalSize;
                
                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                storageInfo.innerHTML = `
                    <div><strong>Cache App:</strong> ${formatBytes(appSize)}</div>
                    <div><strong>Cache Medicamentos:</strong> ${formatBytes(medSize)}</div>
                    <div><strong>Cache Total:</strong> ${formatBytes(totalSize)} / ${formatBytes(totalLimit)}</div>
                    <div><strong>Espa√ßo Livre:</strong> ${formatBytes(freeSpace)}</div>
                    <div><strong>Porcentagem Usada:</strong> ${((totalSize / totalLimit) * 100).toFixed(2)}%</div>
                `;
            }
            
            checkPWAStatus() {
                const pwaStatus = document.getElementById('pwa-status');
                if (!pwaStatus) return;
                
                let statusHTML = '';
                
                // Verifica se √© PWA instalado
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    statusHTML += '<div style="color: var(--success);"><i class="fas fa-check-circle"></i> PWA instalado</div>';
                } else {
                    statusHTML += '<div style="color: var(--warning);"><i class="fas fa-info-circle"></i> PWA n√£o instalado</div>';
                }
                
                // Verifica se est√° online/offline
                if (navigator.onLine) {
                    statusHTML += '<div style="color: var(--success);"><i class="fas fa-wifi"></i> Online</div>';
                } else {
                    statusHTML += '<div style="color: var(--warning);"><i class="fas fa-wifi-slash"></i> Offline (modo PWA ativo)</div>';
                }
                
                // Verifica Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        statusHTML += '<div style="color: var(--success);"><i class="fas fa-check-circle"></i> Service Worker ativo</div>';
                        pwaStatus.innerHTML = statusHTML;
                    }).catch(() => {
                        statusHTML += '<div style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Service Worker n√£o registrado</div>';
                        pwaStatus.innerHTML = statusHTML;
                    });
                } else {
                    statusHTML += '<div style="color: var(--danger);"><i class="fas fa-times-circle"></i> Service Worker n√£o suportado</div>';
                    pwaStatus.innerHTML = statusHTML;
                }
            }
        }

        // Sistema principal
        class VeterinarySystem {
            constructor() {
                this.cacheManager = new CacheManager();
                this.timezone = null;
                this.currentDate = new Date();
                this.calendarMonth = new Date().getMonth();
                this.calendarYear = new Date().getFullYear();
                this.selectedDay = null;
                this.upcomingTimers = [];
                this.medicationsData = null; // Para armazenar dados de medications.json
                
                // Estado inicial dos animais
                this.animals = {};
            }
            
            init() {
                this.loadFromCache();
                this.setupEventListeners();
                this.setupTheme();
                this.updateTime();
                this.cacheManager.updateCacheDisplay();
                this.cacheManager.checkPWAStatus();
                this.renderAll();
                this.startTimers();
                this.updateIndicators();
                this.updateHistoryTable();
                this.loadMedicationsData();
                this.setupCustomDateFilter();
                
                setInterval(() => this.updateTime(), 1000);
                setInterval(() => this.cacheManager.updateCacheDisplay(), 5000);
                setInterval(() => this.updateUpcomingMedications(), 1000);
                setInterval(() => this.updateIndicators(), 60000);
                
                // Registra Service Worker para PWA
                this.registerServiceWorker();
            }
            
            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => {
                            console.log('Service Worker registrado com sucesso:', registration);
                            
                            // Verifica atualiza√ß√µes
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showNotification('Nova vers√£o dispon√≠vel! Atualize a p√°gina.', 'info');
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.error('Erro ao registrar Service Worker:', error);
                        });
                    
                    // Lida com mensagens do Service Worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data && event.data.type === 'CACHE_UPDATED') {
                            showNotification('Cache atualizado para uso offline!', 'info');
                        }
                    });
                }
            }
            
            setupCustomDateFilter() {
                const periodSelect = document.getElementById('history-period-select');
                const customDateRange = document.getElementById('custom-date-range');
                
                if (periodSelect && customDateRange) {
                    periodSelect.addEventListener('change', function() {
                        if (this.value === 'custom') {
                            customDateRange.style.display = 'block';
                            
                            // Define datas padr√£o para o intervalo personalizado
                            const today = new Date();
                            const oneMonthAgo = new Date();
                            oneMonthAgo.setMonth(today.getMonth() - 1);
                            
                            const startDateInput = document.getElementById('custom-start-date');
                            const endDateInput = document.getElementById('custom-end-date');
                            
                            if (startDateInput && endDateInput) {
                                startDateInput.value = oneMonthAgo.toISOString().split('T')[0];
                                endDateInput.value = today.toISOString().split('T')[0];
                            }
                        } else {
                            customDateRange.style.display = 'none';
                        }
                    });
                }
            }
            
            async loadMedicationsData() {
                try {
                    const response = await fetch('medications.json');
                    if (response.ok) {
                        this.medicationsData = await response.json();
                        console.log('Dados de medicamentos carregados:', this.medicationsData);
                    }
                } catch (error) {
                    console.log('N√£o foi poss√≠vel carregar medications.json, usando cache local');
                    const cached = this.cacheManager.getMedicationsFromCache();
                    if (cached) {
                        this.medicationsData = cached;
                    }
                }
            }
            
            async loadFrajolaNenemData() {
                try {
                    const response = await fetch('frajola_e_nenem.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (confirm('Isso ir√° carregar os dados dos seus gatos (Frajola e Nen√©m) com todos os medicamentos e hor√°rios. Deseja continuar?')) {
                            this.animals = data.animals || {};
                            this.calendarMonth = data.calendarMonth || new Date().getMonth();
                            this.calendarYear = data.calendarYear || new Date().getFullYear();
                            
                            // Se houver cache de medicamentos, carrega
                            if (data.medications_cache) {
                                this.medicationsData = { medications: data.medications_cache };
                                this.cacheManager.saveMedicationsToCache(this.medicationsData);
                            }
                            
                            this.saveToCache();
                            this.populateAnimalSelect();
                            this.populateExportAnimalSelect();
                            this.populateHistoryFilters();
                            this.renderAll();
                            this.updateUpcomingMedications();
                            this.updateIndicators();
                            this.updateHistoryTable();
                            showNotification('Dados dos seus gatos carregados com sucesso!');
                        }
                    } else {
                        throw new Error('Arquivo n√£o encontrado');
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados dos gatos:', error);
                    showNotification('Erro ao carregar dados dos gatos. Verifique se o arquivo frajola_e_nenem.json est√° na pasta correta.', 'warning');
                    
                    // Usa dados embutidos como fallback
                    const data = {
                        "animals": {
                            "frajola": {
                                "id": "frajola",
                                "name": "Frajola",
                                "weight": "4,5 kg",
                                "breed": "SRD",
                                "type": "cat",
                                "icon": "üê±",
                                "medications": {
                                    "vetmax_plus": {
                                        "id": "vetmax_plus",
                                        "name": "Vetmax Plus",
                                        "dosage": "¬Ω comprimido",
                                        "frequency": "daily",
                                        "schedule": "morning",
                                        "startDate": "2025-12-16",
                                        "duration": 3,
                                        "durationType": "days",
                                        "cycleDays": 15,
                                        "history": [],
                                        "scheduledDates": [
                                            "2025-12-16",
                                            "2025-12-17",
                                            "2025-12-18",
                                            "2026-01-02",
                                            "2026-01-03",
                                            "2026-01-04"
                                        ]
                                    },
                                    "omegablue_esqualeno": {
                                        "id": "omegablue_esqualeno",
                                        "name": "Omegablue Esqualeno",
                                        "dosage": "1 c√°psula",
                                        "frequency": "48h",
                                        "schedule": "night",
                                        "startDate": "2025-12-16",
                                        "duration": null,
                                        "durationType": "continuous",
                                        "history": [],
                                        "scheduledDates": [
                                            "2025-12-16",
                                            "2025-12-18",
                                            "2025-12-20",
                                            "2025-12-22",
                                            "2025-12-24",
                                            "2025-12-26"
                                        ]
                                    }
                                }
                            },
                            "nenem": {
                                "id": "nenem",
                                "name": "Nen√©m",
                                "weight": "3,8 kg",
                                "breed": "SRD",
                                "type": "cat",
                                "icon": "üê±",
                                "medications": {
                                    "petsporin_75mg": {
                                        "id": "petsporin_75mg",
                                        "name": "Petsporin 75 mg",
                                        "dosage": "¬Ω comprimido",
                                        "frequency": "12h",
                                        "schedule": "both",
                                        "startDate": "2025-12-16",
                                        "duration": 7,
                                        "durationType": "days",
                                        "history": [],
                                        "scheduledDates": [
                                            "2025-12-16_morning",
                                            "2025-12-16_night",
                                            "2025-12-17_morning",
                                            "2025-12-17_night"
                                        ]
                                    }
                                }
                            }
                        }
                    };
                    
                    if (confirm('Deseja carregar dados de exemplo do Frajola e Nen√©m?')) {
                        this.animals = data.animals || {};
                        this.saveToCache();
                        this.populateAnimalSelect();
                        this.populateExportAnimalSelect();
                        this.populateHistoryFilters();
                        this.renderAll();
                        showNotification('Dados de exemplo carregados com sucesso!');
                    }
                }
            }
            
            async loadSampleData() {
                // Dados de exemplo para demonstra√ß√£o
                const sampleData = {
                    "animals": {
                        "rex": {
                            "id": "rex",
                            "name": "Rex",
                            "weight": "12,5 kg",
                            "breed": "Labrador",
                            "type": "dog",
                            "icon": "üê∂",
                            "medications": {
                                "antibiotico": {
                                    "id": "antibiotico",
                                    "name": "Antibi√≥tico Canino",
                                    "dosage": "1 comprimido",
                                    "frequency": "daily",
                                    "schedule": "morning",
                                    "startDate": new Date().toISOString().split('T')[0],
                                    "duration": 10,
                                    "durationType": "days",
                                    "history": [],
                                    "scheduledDates": []
                                }
                            }
                        }
                    }
                };
                
                if (confirm('Isso ir√° carregar dados de exemplo para demonstra√ß√£o. Deseja continuar?')) {
                    // Adiciona os dados de exemplo aos animais existentes
                    Object.assign(this.animals, sampleData.animals);
                    
                    this.saveToCache();
                    this.populateAnimalSelect();
                    this.populateExportAnimalSelect();
                    this.populateHistoryFilters();
                    this.renderAll();
                    showNotification('Dados de exemplo carregados com sucesso!');
                }
            }
            
            clearAllData() {
                if (confirm('ATEN√á√ÉO: Isso ir√° limpar TODOS os dados do sistema, incluindo animais, medicamentos e hist√≥rico. Esta a√ß√£o n√£o pode ser desfeita. Tem certeza?')) {
                    this.animals = {};
                    this.saveToCache();
                    this.populateAnimalSelect();
                    this.populateExportAnimalSelect();
                    this.populateHistoryFilters();
                    this.renderAll();
                    showNotification('Todos os dados foram limpos!', 'info');
                }
            }
            
            async loadMedicationsFromJSON() {
                if (!this.medicationsData) {
                    await this.loadMedicationsData();
                }
                
                if (this.medicationsData && this.medicationsData.medications) {
                    if (this.cacheManager.saveMedicationsToCache(this.medicationsData)) {
                        showNotification('Medicamentos carregados e salvos em cache!');
                    }
                } else {
                    showNotification('Nenhum dado de medicamentos dispon√≠vel', 'warning');
                }
            }
            
            setupTheme() {
                const themeToggle = document.getElementById('theme-toggle');
                const savedTheme = localStorage.getItem('vetmed_theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                
                themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                
                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.body.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    
                    document.body.setAttribute('data-theme', newTheme);
                    themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                    
                    localStorage.setItem('vetmed_theme', newTheme);
                });
            }
            
            setupEventListeners() {
                // Toggle de tipo de dura√ß√£o
                const durationTypeSelect = document.getElementById('new-med-duration-type');
                if (durationTypeSelect) {
                    durationTypeSelect.addEventListener('change', () => this.toggleDurationFields());
                }
                
                // Configura datas padr√£o
                const startDateInput = document.getElementById('new-med-start-date');
                if (startDateInput) {
                    const today = new Date();
                    startDateInput.value = this.formatDate(today);
                }
                
                const exportStartDate = document.getElementById('export-start-date');
                const exportEndDate = document.getElementById('export-end-date');
                if (exportStartDate && exportEndDate) {
                    const today = new Date();
                    exportStartDate.value = this.formatDate(today);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    exportEndDate.value = this.formatDate(endOfMonth);
                }
                
                // Valida√ß√£o em tempo real
                this.setupValidation();
                
                // Detectar online/offline
                window.addEventListener('online', () => {
                    showNotification('Conectado √† internet', 'info');
                    this.cacheManager.checkPWAStatus();
                });
                
                window.addEventListener('offline', () => {
                    showNotification('Modo offline ativado - PWA funcionando', 'warning');
                    this.cacheManager.checkPWAStatus();
                });
            }
            
            toggleDurationFields() {
                const durationTypeSelect = document.getElementById('new-med-duration-type');
                const daysContainer = document.getElementById('duration-days-container');
                const endDateContainer = document.getElementById('end-date-container');
                
                if (!durationTypeSelect || !daysContainer || !endDateContainer) return;
                
                if (durationTypeSelect.value === 'days') {
                    daysContainer.classList.remove('hidden');
                    endDateContainer.classList.add('hidden');
                } else if (durationTypeSelect.value === 'end_date') {
                    daysContainer.classList.add('hidden');
                    endDateContainer.classList.remove('hidden');
                    
                    // Define data de t√©rmino padr√£o (7 dias ap√≥s hoje)
                    const endDateInput = document.getElementById('new-med-end-date');
                    if (endDateInput) {
                        const today = new Date();
                        const endDate = new Date(today);
                        endDate.setDate(today.getDate() + 7);
                        endDateInput.value = endDate.toISOString().split('T')[0];
                    }
                } else {
                    daysContainer.classList.add('hidden');
                    endDateContainer.classList.add('hidden');
                }
            }
            
            toggleCustomFrequency() {
                const frequencySelect = document.getElementById('new-med-frequency');
                const customFields = document.getElementById('custom-frequency-fields');
                
                if (!frequencySelect || !customFields) return;
                
                if (frequencySelect.value === 'custom') {
                    customFields.classList.remove('hidden');
                } else {
                    customFields.classList.add('hidden');
                }
            }
            
            setupValidation() {
                // Valida√ß√£o do peso do animal
                const weightInput = document.getElementById('new-animal-weight');
                if (weightInput) {
                    weightInput.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        const errorElement = document.getElementById('animal-weight-error');
                        
                        if (errorElement) {
                            if (value < 0.1 || value > 200) {
                                e.target.classList.add('input-error');
                                errorElement.textContent = 'Peso deve estar entre 0.1kg e 200kg';
                                errorElement.style.display = 'block';
                            } else {
                                e.target.classList.remove('input-error');
                                errorElement.style.display = 'none';
                            }
                        }
                    });
                }
            }
            
            getCurrentDate() {
                return this.formatDate(new Date());
            }
            
            formatDate(date) {
                return date.toISOString().split('T')[0];
            }
            
            formatDateTime(date) {
                return date.toLocaleString('pt-BR');
            }
            
            generateScheduledDates(frequency, startDate, duration, durationType, customHours = 24) {
                const scheduledDates = [];
                const start = new Date(startDate);
                
                if (durationType === 'continuous') {
                    // Para medicamentos cont√≠nuos, gerar para os pr√≥ximos 90 dias
                    for (let i = 0; i < 90; i++) {
                        const date = new Date(start);
                        date.setDate(start.getDate() + i);
                        this.addDateBasedOnFrequency(date, frequency, scheduledDates, customHours);
                    }
                } else {
                    // Para medicamentos com dura√ß√£o definida
                    const endDate = durationType === 'days' ? 
                        new Date(start.getTime() + (duration * 24 * 60 * 60 * 1000)) :
                        new Date(duration);
                    
                    let currentDate = new Date(start);
                    let dayCount = 0;
                    
                    while (currentDate <= endDate && dayCount < 365) {
                        this.addDateBasedOnFrequency(currentDate, frequency, scheduledDates, customHours);
                        currentDate.setDate(currentDate.getDate() + 1);
                        dayCount++;
                    }
                }
                
                return scheduledDates;
            }
            
            addDateBasedOnFrequency(date, frequency, scheduledDates, customHours = 24) {
                const dateStr = date.toISOString().split('T')[0];
                
                if (frequency === 'daily') {
                    scheduledDates.push(dateStr);
                } else if (frequency === '12h') {
                    scheduledDates.push(dateStr + '_morning');
                    scheduledDates.push(dateStr + '_night');
                } else if (frequency === '48h') {
                    const daysSinceStart = Math.floor((date - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysSinceStart % 2 === 0) {
                        scheduledDates.push(dateStr);
                    }
                } else if (frequency === 'weekly') {
                    if (date.getDay() === 0) { // Domingo
                        scheduledDates.push(dateStr);
                    }
                } else if (frequency === 'custom') {
                    const hoursSinceStart = Math.floor((date - new Date()) / (1000 * 60 * 60));
                    if (hoursSinceStart % customHours === 0) {
                        scheduledDates.push(dateStr);
                    }
                }
            }
            
            async updateTime() {
                try {
                    const response = await fetch('https://worldtimeapi.org/api/ip');
                    const data = await response.json();
                    
                    this.timezone = data.timezone;
                    const now = new Date(data.datetime);
                    
                    document.getElementById('local-time').textContent = 
                        now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    
                    document.getElementById('current-date').textContent = 
                        now.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    
                } catch (error) {
                    const now = new Date();
                    document.getElementById('local-time').textContent = 
                        now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    document.getElementById('current-date').textContent = 
                        now.toLocaleDateString('pt-BR');
                }
            }
            
            updateUpcomingMedications() {
                const container = document.getElementById('upcoming-medications-list');
                const countElement = document.getElementById('next-medication-count');
                const overdueContainer = document.getElementById('overdue-medication-count');
                const overdueCountElement = document.getElementById('overdue-count');
                
                if (!container || !countElement || !overdueContainer || !overdueCountElement) return;
                
                const upcoming = this.getUpcomingMedications();
                const overdueCount = upcoming.filter(m => m.isOverdue).length;
                
                container.innerHTML = '';
                
                if (upcoming.length === 0) {
                    container.innerHTML = '<p class="text-center" style="width: 100%;">Nenhuma medica√ß√£o pr√≥xima no momento.</p>';
                    countElement.textContent = 'Pr√≥ximas: 0';
                    overdueContainer.style.display = 'none';
                    return;
                }
                
                countElement.textContent = `Pr√≥ximas: ${upcoming.length - overdueCount}`;
                overdueCountElement.textContent = overdueCount;
                
                if (overdueCount > 0) {
                    overdueContainer.style.display = 'flex';
                } else {
                    overdueContainer.style.display = 'none';
                }
                
                upcoming.forEach(med => {
                    const item = document.createElement('div');
                    item.className = `upcoming-item ${med.urgent ? 'urgent' : ''} ${med.isOverdue ? 'overdue' : ''}`;
                    
                    const timeLeft = med.isOverdue ? 
                        `Atrasada: ${med.timeLeft}` : 
                        `Faltam: ${med.timeLeft}`;
                    
                    const progress = med.isOverdue ? 100 : this.calculateProgress(med.nextTime);
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 1.5rem;">${med.animalIcon}</div>
                                <div>
                                    <h4 style="margin: 0;">${med.medicationName}</h4>
                                    <p style="margin: 0; font-size: 0.9rem;">${med.animalName} - ${med.dosage}</p>
                                </div>
                            </div>
                            <div style="font-size: 1.2rem; color: ${med.isOverdue ? 'var(--warning)' : (med.urgent ? 'var(--danger)' : 'var(--primary)')}">
                                ${med.timeOfDay === 'morning' ? '‚òÄÔ∏è' : 'üåô'}
                            </div>
                        </div>
                        
                        <div class="countdown-timer ${med.isOverdue ? 'overdue-timer' : ''}">${timeLeft}</div>
                        
                        <div style="font-size: 0.85rem; margin-bottom: 5px;">
                            Pr√≥xima: ${med.nextDateTime}
                        </div>
                        
                        <div class="progress-bar-container">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px;">
                                <span>${med.isOverdue ? 'Atrasado' : 'Progresso'}</span>
                                <span>${progress.toFixed(2)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress.toFixed(2)}%; background: ${med.isOverdue ? 'linear-gradient(90deg, var(--warning), var(--danger))' : 'linear-gradient(90deg, var(--secondary), var(--info))'}"></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                            <button class="btn btn-mark btn-small" style="flex: 1;" onclick="vetSystem.markMedicationFromUpcoming('${med.animalId}', '${med.medicationId}', '${med.timeOfDay}')">
                                <i class="fas fa-check"></i> Marcar como Administrado
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            getUpcomingMedications() {
                const upcoming = [];
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const today = this.getCurrentDate();
                
                // Hor√°rios de medica√ß√£o
                const morningTime = 7 * 60 + 30; // 07:30
                const nightTime = 19 * 60 + 30; // 19:30
                
                // Verifica medica√ß√µes para hoje e amanh√£
                for (let dayOffset = 0; dayOffset < 2; dayOffset++) {
                    const date = new Date();
                    date.setDate(date.getDate() + dayOffset);
                    const dateStr = this.formatDate(date);
                    
                    Object.entries(this.animals).forEach(([animalId, animal]) => {
                        Object.entries(animal.medications).forEach(([medId, med]) => {
                            // Verifica se a medica√ß√£o est√° agendada para hoje/amanh√£
                            const isScheduled = med.scheduledDates.some(scheduledDate => {
                                if (scheduledDate.includes('_')) {
                                    return scheduledDate.startsWith(dateStr);
                                }
                                return scheduledDate === dateStr;
                            });
                            
                            if (!isScheduled) return;
                            
                            // Para cada hor√°rio (manh√£ e noite, se aplic√°vel)
                            const times = [];
                            if (med.schedule === 'morning' || med.schedule === 'both') {
                                times.push({ timeOfDay: 'morning', targetTime: morningTime });
                            }
                            if (med.schedule === 'night' || med.schedule === 'both') {
                                times.push({ timeOfDay: 'night', targetTime: nightTime });
                            }
                            
                            times.forEach(({ timeOfDay, targetTime }) => {
                                // Verifica se j√° foi administrada
                                const recordKey = med.schedule === 'both' ? `${dateStr}_${timeOfDay}` : dateStr;
                                const historyRecord = med.history.find(record => record.date === recordKey);
                                
                                if (historyRecord) return; // J√° administrada
                                
                                // Calcula o tempo at√© a medica√ß√£o
                                const targetDateTime = new Date(date);
                                targetDateTime.setHours(Math.floor(targetTime / 60), targetTime % 60, 0, 0);
                                
                                let timeUntil = targetDateTime - now;
                                let isOverdue = false;
                                
                                if (timeUntil < 0) {
                                    // J√° passou do hor√°rio -> atrasada
                                    isOverdue = true;
                                    timeUntil = Math.abs(timeUntil);
                                }
                                
                                // Converte para horas e minutos
                                const hoursUntil = Math.floor(timeUntil / (1000 * 60 * 60));
                                const minutesUntil = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
                                
                                // S√≥ mostra se for hoje (atrasada ou dentro de 2 horas) ou amanh√£ (dentro de 24 horas)
                                const shouldShow = (dayOffset === 0 && (isOverdue || hoursUntil < 2)) || 
                                                 (dayOffset === 1 && hoursUntil < 24);
                                
                                if (shouldShow) {
                                    const timeLeft = isOverdue ? 
                                        `${hoursUntil}h ${minutesUntil}m atrasado` : 
                                        `${hoursUntil}h ${minutesUntil}m`;
                                    
                                    upcoming.push({
                                        animalId: animalId,
                                        animalName: animal.name,
                                        animalIcon: animal.icon,
                                        medicationId: medId,
                                        medicationName: med.name,
                                        dosage: med.dosage,
                                        timeOfDay: timeOfDay,
                                        date: dateStr,
                                        nextTime: `${Math.floor(targetTime / 60)}:${(targetTime % 60).toString().padStart(2, '0')}`,
                                        nextDateTime: `${dateStr} ${Math.floor(targetTime / 60)}:${(targetTime % 60).toString().padStart(2, '0')}`,
                                        isOverdue: isOverdue,
                                        urgent: !isOverdue && hoursUntil === 0 && minutesUntil < 30,
                                        timeLeft: timeLeft
                                    });
                                }
                            });
                        });
                    });
                }
                
                // Ordena: primeiro as atrasadas, depois as urgentes, depois as normais
                upcoming.sort((a, b) => {
                    if (a.isOverdue && !b.isOverdue) return -1;
                    if (!a.isOverdue && b.isOverdue) return 1;
                    if (a.urgent && !b.urgent) return -1;
                    if (!a.urgent && b.urgent) return 1;
                    return 0;
                });
                
                return upcoming.slice(0, 6); // Limita a 6
            }
            
            calculateProgress(nextTime) {
                const now = new Date();
                const [hours, minutes] = nextTime.split(':').map(Number);
                const targetTime = new Date(now);
                targetTime.setHours(hours, minutes, 0, 0);
                
                if (targetTime < now) {
                    targetTime.setDate(targetTime.getDate() + 1);
                }
                
                const twoHoursBefore = new Date(targetTime);
                twoHoursBefore.setHours(targetTime.getHours() - 2);
                
                if (now < twoHoursBefore) return 0;
                if (now > targetTime) return 100;
                
                const totalWindow = targetTime - twoHoursBefore;
                const elapsed = now - twoHoursBefore;
                return Math.min(100, Math.max(0, (elapsed / totalWindow) * 100));
            }
            
            markMedicationFromUpcoming(animalId, medicationId, timeOfDay) {
                this.toggleMedication(animalId, medicationId, timeOfDay);
            }
            
            startTimers() {
                // Atualiza a cada minuto
                setInterval(() => {
                    this.updateUpcomingMedications();
                }, 60000);
            }
            
            updateIndicators() {
                const indicatorsGrid = document.getElementById('indicators-grid');
                if (!indicatorsGrid) return;
                
                indicatorsGrid.innerHTML = '';
                
                // Calcula indicadores
                const indicators = this.calculateIndicators();
                
                // Renderiza indicadores
                Object.entries(indicators).forEach(([key, indicator]) => {
                    const indicatorCard = document.createElement('div');
                    indicatorCard.className = 'indicator-card';
                    
                    indicatorCard.innerHTML = `
                        <div class="indicator-value">${indicator.value}</div>
                        <div class="indicator-label">${indicator.label}</div>
                    `;
                    
                    indicatorsGrid.appendChild(indicatorCard);
                });
            }
            
            calculateIndicators() {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                let totalScheduled = 0;
                let totalAdministered = 0;
                let totalLate = 0;
                let totalAnimals = Object.keys(this.animals).length;
                let totalMedications = 0;
                
                Object.values(this.animals).forEach(animal => {
                    totalMedications += Object.keys(animal.medications).length;
                    
                    Object.values(animal.medications).forEach(med => {
                        // Conta medica√ß√µes agendadas nos √∫ltimos 30 dias
                        med.scheduledDates.forEach(scheduledDate => {
                            const dateStr = scheduledDate.split('_')[0];
                            const date = new Date(dateStr);
                            if (date >= thirtyDaysAgo && date <= today) {
                                totalScheduled++;
                                
                                // Verifica se foi administrada
                                const historyRecord = med.history.find(record => 
                                    record.date.startsWith(dateStr) &&
                                    (med.schedule !== 'both' || record.timeOfDay === scheduledDate.split('_')[1])
                                );
                                
                                if (historyRecord) {
                                    totalAdministered++;
                                    
                                    // Verifica se foi administrada com atraso
                                    if (historyRecord.status === 'late') {
                                        totalLate++;
                                    }
                                }
                            }
                        });
                    });
                });
                
                const adherenceRate = totalScheduled > 0 ? ((totalAdministered / totalScheduled) * 100).toFixed(1) : 0;
                const punctualityRate = totalAdministered > 0 ? (((totalAdministered - totalLate) / totalAdministered) * 100).toFixed(1) : 0;
                
                return {
                    totalAnimals: {
                        value: totalAnimals,
                        label: 'Total de Animais'
                    },
                    totalMedications: {
                        value: totalMedications,
                        label: 'Total de Medicamentos'
                    },
                    adherenceRate: {
                        value: `${adherenceRate}%`,
                        label: 'Taxa de Ader√™ncia (30 dias)'
                    },
                    punctualityRate: {
                        value: `${punctualityRate}%`,
                        label: 'Taxa de Pontualidade (30 dias)'
                    }
                };
            }
            
            updateHistoryTable() {
                const tableBody = document.getElementById('history-table-body');
                if (!tableBody) return;
                
                // Obt√©m os filtros selecionados
                const animalSelect = document.getElementById('history-animal-select');
                const medicationSelect = document.getElementById('history-medication-select');
                const periodSelect = document.getElementById('history-period-select');
                
                if (!animalSelect || !medicationSelect || !periodSelect) return;
                
                const selectedAnimal = animalSelect.value;
                const selectedMedication = medicationSelect.value;
                const selectedPeriod = periodSelect.value;
                
                // Calcula a data inicial do per√≠odo
                const today = new Date();
                let startDate;
                
                if (selectedPeriod === 'custom') {
                    const customStartDate = document.getElementById('custom-start-date').value;
                    const customEndDate = document.getElementById('custom-end-date').value;
                    
                    if (!customStartDate || !customEndDate) {
                        showNotification('Por favor, selecione as datas para o per√≠odo personalizado!', 'warning');
                        return;
                    }
                    
                    startDate = new Date(customStartDate);
                    const endDate = new Date(customEndDate);
                    
                    // Ajusta para incluir todo o dia final
                    endDate.setHours(23, 59, 59, 999);
                    
                    // Filtra o hist√≥rico
                    const history = this.getFilteredHistory(selectedAnimal, selectedMedication, startDate, endDate);
                    this.renderHistoryTable(tableBody, history);
                    return;
                } else {
                    const periodDays = parseInt(selectedPeriod);
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - periodDays);
                }
                
                // Filtra o hist√≥rico
                const history = this.getFilteredHistory(selectedAnimal, selectedMedication, startDate, today);
                this.renderHistoryTable(tableBody, history);
            }
            
            getFilteredHistory(animalFilter, medicationFilter, startDate, endDate) {
                const history = [];
                
                Object.entries(this.animals).forEach(([animalId, animal]) => {
                    if (animalFilter !== 'all' && animalId !== animalFilter) return;
                    
                    Object.entries(animal.medications).forEach(([medId, med]) => {
                        if (medicationFilter !== 'all' && medId !== medicationFilter) return;
                        
                        // Primeiro, adiciona as medica√ß√µes administradas
                        med.history.forEach(record => {
                            const recordDate = new Date(record.timestamp);
                            if (recordDate >= startDate && recordDate <= endDate) {
                                // Determina o hor√°rio previsto
                                let scheduledTime = this.getScheduledTime(record.date, record.timeOfDay || med.schedule);
                                let delayMinutes = null;
                                
                                if (scheduledTime) {
                                    delayMinutes = Math.round((recordDate - scheduledTime) / (1000 * 60));
                                }
                                
                                history.push({
                                    type: 'administered',
                                    animalName: animal.name,
                                    animalIcon: animal.icon,
                                    medicationName: med.name,
                                    dosage: med.dosage,
                                    date: record.date.split('_')[0],
                                    timeOfDay: record.timeOfDay || med.schedule,
                                    timestamp: record.timestamp,
                                    status: record.status || 'ok',
                                    scheduledTime: scheduledTime,
                                    delay: delayMinutes,
                                    administeredTime: recordDate,
                                    notes: record.notes || ''
                                });
                            }
                        });
                        
                        // Depois, adiciona as medica√ß√µes pendentes/atrasadas
                        const today = new Date();
                        med.scheduledDates.forEach(scheduledDate => {
                            let dateStr, timeOfDay;
                            
                            if (scheduledDate.includes('_')) {
                                [dateStr, timeOfDay] = scheduledDate.split('_');
                            } else {
                                dateStr = scheduledDate;
                                timeOfDay = med.schedule;
                            }
                            
                            const scheduledDateObj = new Date(dateStr);
                            if (scheduledDateObj >= startDate && scheduledDateObj <= endDate) {
                                // Verifica se j√° foi administrada
                                const historyRecord = med.history.find(record => 
                                    record.date === scheduledDate
                                );
                                
                                if (!historyRecord) {
                                    // √â uma medica√ß√£o pendente ou atrasada
                                    let scheduledTime = this.getScheduledTime(dateStr, timeOfDay);
                                    let status = 'pending';
                                    let delayMinutes = null;
                                    
                                    if (scheduledTime && today > scheduledTime) {
                                        // Est√° atrasada
                                        status = 'late';
                                        delayMinutes = Math.round((today - scheduledTime) / (1000 * 60));
                                    }
                                    
                                    history.push({
                                        type: status === 'late' ? 'late' : 'pending',
                                        animalName: animal.name,
                                        animalIcon: animal.icon,
                                        medicationName: med.name,
                                        dosage: med.dosage,
                                        date: dateStr,
                                        timeOfDay: timeOfDay,
                                        timestamp: null,
                                        status: status,
                                        scheduledTime: scheduledTime,
                                        delay: delayMinutes,
                                        administeredTime: null,
                                        notes: ''
                                    });
                                }
                            }
                        });
                    });
                });
                
                // Ordena por data/hora (mais recente primeiro)
                history.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    } else if (a.timestamp && !b.timestamp) {
                        return -1;
                    } else if (!a.timestamp && b.timestamp) {
                        return 1;
                    } else {
                        // Ambos sem timestamp, ordena pela data agendada
                        const dateA = a.scheduledTime || new Date(a.date);
                        const dateB = b.scheduledTime || new Date(b.date);
                        return dateB - dateA;
                    }
                });
                
                return history;
            }
            
            getScheduledTime(dateStr, timeOfDay) {
                const date = new Date(dateStr);
                
                if (timeOfDay === 'morning') {
                    date.setHours(7, 30, 0, 0);
                    return date;
                } else if (timeOfDay === 'night') {
                    date.setHours(19, 30, 0, 0);
                    return date;
                }
                
                return null;
            }
            
            renderHistoryTable(tableBody, history) {
                // Limpa a tabela
                tableBody.innerHTML = '';
                
                // Preenche a tabela
                if (history.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="10" style="text-align: center;">Nenhum registro encontrado no per√≠odo selecionado.</td>
                    `;
                    tableBody.appendChild(row);
                } else {
                    history.forEach(record => {
                        const row = document.createElement('tr');
                        
                        // Formata a data e hora
                        let formattedDate = '';
                        let formattedTime = '';
                        let scheduledTimeStr = '';
                        let administeredTimeStr = '';
                        let delayText = '';
                        let statusBadge = '';
                        
                        if (record.scheduledTime) {
                            scheduledTimeStr = record.scheduledTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        }
                        
                        if (record.type === 'administered') {
                            const date = new Date(record.timestamp);
                            formattedDate = date.toLocaleDateString('pt-BR');
                            formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            administeredTimeStr = formattedTime;
                            
                            if (record.delay !== null) {
                                if (record.delay > 0) {
                                    delayText = `+${record.delay} min`;
                                    statusBadge = `<span class="history-status-badge badge-late">Atrasado (${delayText})</span>`;
                                } else if (record.delay < 0) {
                                    delayText = `${Math.abs(record.delay)} min antes`;
                                    statusBadge = `<span class="history-status-badge badge-on-time">Antecipado (${delayText})</span>`;
                                } else {
                                    delayText = 'No hor√°rio';
                                    statusBadge = `<span class="history-status-badge badge-on-time">No prazo</span>`;
                                }
                            }
                        } else if (record.type === 'late') {
                            formattedDate = new Date(record.date).toLocaleDateString('pt-BR');
                            formattedTime = '--:--';
                            administeredTimeStr = 'N√£o administrado';
                            
                            if (record.delay !== null) {
                                delayText = `+${record.delay} min`;
                                statusBadge = `<span class="history-status-badge badge-late">Atrasado (${delayText})</span>`;
                            }
                        } else if (record.type === 'pending') {
                            formattedDate = new Date(record.date).toLocaleDateString('pt-BR');
                            formattedTime = '--:--';
                            administeredTimeStr = 'Pendente';
                            statusBadge = `<span class="history-status-badge badge-pending">Pendente</span>`;
                        }
                        
                        // Hor√°rio previsto formatado
                        const scheduledTimeFormatted = record.timeOfDay === 'morning' ? 
                            'Manh√£ (07:30)' : 
                            record.timeOfDay === 'night' ? 
                            'Noite (19:30)' : 
                            scheduledTimeStr;
                        
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${formattedTime}</td>
                            <td>${record.animalIcon} ${record.animalName}</td>
                            <td>${record.medicationName}</td>
                            <td>${record.dosage}</td>
                            <td>${scheduledTimeFormatted}</td>
                            <td>${administeredTimeStr}</td>
                            <td>${statusBadge}</td>
                            <td>${delayText}</td>
                            <td>
                                <div class="history-actions">
                                    ${record.type === 'administered' ? `
                                        <button class="btn btn-edit btn-small" onclick="vetSystem.viewHistoryDetails('${record.animalName}', '${record.medicationName}', '${record.timestamp}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-mark btn-small" onclick="vetSystem.markPendingMedication('${record.animalName}', '${record.medicationName}', '${record.date}', '${record.timeOfDay}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    `}
                                </div>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            }
            
            markPendingMedication(animalName, medicationName, date, timeOfDay) {
                // Encontra o animal e medicamento
                let targetAnimal = null;
                let targetMedication = null;
                
                for (const [animalId, animal] of Object.entries(this.animals)) {
                    if (animal.name === animalName) {
                        targetAnimal = animal;
                        for (const [medId, med] of Object.entries(animal.medications)) {
                            if (med.name === medicationName) {
                                targetMedication = med;
                                break;
                            }
                        }
                        break;
                    }
                }
                
                if (targetAnimal && targetMedication) {
                    const recordKey = targetMedication.schedule === 'both' ? 
                        `${date}_${timeOfDay}` : date;
                    
                    // Verifica se est√° atrasado
                    const now = new Date();
                    const isOverdue = this.checkIfMedicationIsOverdue(targetMedication, timeOfDay, now);
                    
                    targetMedication.history.push({
                        date: recordKey,
                        timeOfDay: timeOfDay,
                        administered: true,
                        timestamp: new Date().toISOString(),
                        status: isOverdue ? 'late' : 'ok',
                        notes: 'Administrado manualmente do hist√≥rico'
                    });
                    
                    this.saveToCache();
                    this.renderAll();
                    this.updateUpcomingMedications();
                    this.updateIndicators();
                    this.updateHistoryTable();
                    showNotification(`${medicationName} marcado como administrado para ${animalName}!`);
                }
            }
            
            updateAnimalHistory() {
                const tableBody = document.getElementById('animal-history-body');
                if (!tableBody) return;
                
                const animalSelect = document.getElementById('history-animal-specific-select');
                const periodSelect = document.getElementById('history-animal-period');
                
                if (!animalSelect || !periodSelect) return;
                
                const selectedAnimalId = animalSelect.value;
                const selectedPeriod = parseInt(periodSelect.value);
                
                if (!selectedAnimalId) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Selecione um animal</td></tr>';
                    return;
                }
                
                const animal = this.animals[selectedAnimalId];
                if (!animal) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Animal n√£o encontrado</td></tr>';
                    return;
                }
                
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - selectedPeriod);
                
                const history = [];
                
                Object.values(animal.medications).forEach(med => {
                    med.history.forEach(record => {
                        const recordDate = new Date(record.timestamp);
                        if (recordDate >= startDate && recordDate <= today) {
                            // Determina o hor√°rio previsto
                            let scheduledTime = this.getScheduledTime(record.date.split('_')[0], record.timeOfDay || med.schedule);
                            let delayMinutes = null;
                            
                            if (scheduledTime) {
                                delayMinutes = Math.round((recordDate - scheduledTime) / (1000 * 60));
                            }
                            
                            history.push({
                                medicationName: med.name,
                                dosage: med.dosage,
                                timeOfDay: record.timeOfDay || med.schedule,
                                timestamp: record.timestamp,
                                status: record.status || 'ok',
                                scheduledTime: scheduledTime,
                                delay: delayMinutes
                            });
                        }
                    });
                });
                
                // Ordena por data/hora (mais recente primeiro)
                history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                tableBody.innerHTML = '';
                
                if (history.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" style="text-align: center;">Nenhum registro encontrado para ${animal.name} no per√≠odo selecionado.</td>
                    `;
                    tableBody.appendChild(row);
                } else {
                    history.forEach(record => {
                        const row = document.createElement('tr');
                        
                        const date = new Date(record.timestamp);
                        const formattedDate = date.toLocaleDateString('pt-BR');
                        const formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        
                        let statusBadge = '';
                        let delayText = '';
                        
                        if (record.delay !== null) {
                            if (record.delay > 0) {
                                delayText = `+${record.delay} min`;
                                statusBadge = `<span class="history-status-badge badge-late">Atrasado</span>`;
                            } else if (record.delay < 0) {
                                delayText = `${Math.abs(record.delay)} min antes`;
                                statusBadge = `<span class="history-status-badge badge-on-time">Antecipado</span>`;
                            } else {
                                delayText = 'No hor√°rio';
                                statusBadge = `<span class="history-status-badge badge-on-time">No prazo</span>`;
                            }
                        }
                        
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${formattedTime}</td>
                            <td>${record.medicationName}</td>
                            <td>${record.dosage}</td>
                            <td>${record.timeOfDay === 'morning' ? 'Manh√£' : 'Noite'}</td>
                            <td>${statusBadge}</td>
                            <td>${delayText}</td>
                            <td>
                                <button class="btn btn-edit btn-small" onclick="vetSystem.viewHistoryDetails('${animal.name}', '${record.medicationName}', '${record.timestamp}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            }
            
            updateMedicationHistory() {
                const tableBody = document.getElementById('medication-history-body');
                if (!tableBody) return;
                
                const medicationSelect = document.getElementById('history-medication-specific-select');
                const periodSelect = document.getElementById('history-medication-period');
                
                if (!medicationSelect || !periodSelect) return;
                
                const selectedMedicationName = medicationSelect.value;
                const selectedPeriod = parseInt(periodSelect.value);
                
                if (!selectedMedicationName) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Selecione um medicamento</td></tr>';
                    return;
                }
                
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - selectedPeriod);
                
                const history = [];
                
                Object.values(this.animals).forEach(animal => {
                    Object.values(animal.medications).forEach(med => {
                        if (med.name === selectedMedicationName) {
                            med.history.forEach(record => {
                                const recordDate = new Date(record.timestamp);
                                if (recordDate >= startDate && recordDate <= today) {
                                    // Determina o hor√°rio previsto
                                    let scheduledTime = this.getScheduledTime(record.date.split('_')[0], record.timeOfDay || med.schedule);
                                    let delayMinutes = null;
                                    
                                    if (scheduledTime) {
                                        delayMinutes = Math.round((recordDate - scheduledTime) / (1000 * 60));
                                    }
                                    
                                    history.push({
                                        animalName: animal.name,
                                        animalIcon: animal.icon,
                                        dosage: med.dosage,
                                        timeOfDay: record.timeOfDay || med.schedule,
                                        timestamp: record.timestamp,
                                        status: record.status || 'ok',
                                        scheduledTime: scheduledTime,
                                        delay: delayMinutes
                                    });
                                }
                            });
                        }
                    });
                });
                
                // Ordena por data/hora (mais recente primeiro)
                history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                tableBody.innerHTML = '';
                
                if (history.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" style="text-align: center;">Nenhum registro encontrado para ${selectedMedicationName} no per√≠odo selecionado.</td>
                    `;
                    tableBody.appendChild(row);
                } else {
                    history.forEach(record => {
                        const row = document.createElement('tr');
                        
                        const date = new Date(record.timestamp);
                        const formattedDate = date.toLocaleDateString('pt-BR');
                        const formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        
                        let statusBadge = '';
                        let delayText = '';
                        
                        if (record.delay !== null) {
                            if (record.delay > 0) {
                                delayText = `+${record.delay} min`;
                                statusBadge = `<span class="history-status-badge badge-late">Atrasado</span>`;
                            } else if (record.delay < 0) {
                                delayText = `${Math.abs(record.delay)} min antes`;
                                statusBadge = `<span class="history-status-badge badge-on-time">Antecipado</span>`;
                            } else {
                                delayText = 'No hor√°rio';
                                statusBadge = `<span class="history-status-badge badge-on-time">No prazo</span>`;
                            }
                        }
                        
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${formattedTime}</td>
                            <td>${record.animalIcon} ${record.animalName}</td>
                            <td>${record.dosage}</td>
                            <td>${record.timeOfDay === 'morning' ? 'Manh√£' : 'Noite'}</td>
                            <td>${statusBadge}</td>
                            <td>${delayText}</td>
                            <td>
                                <button class="btn btn-edit btn-small" onclick="vetSystem.viewHistoryDetails('${record.animalName}', '${selectedMedicationName}', '${record.timestamp}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                }
            }
            
            updateDetailedHistory() {
                const container = document.getElementById('detailed-history-container');
                if (!container) return;
                
                const animalSelect = document.getElementById('history-detailed-animal');
                const periodSelect = document.getElementById('history-detailed-period');
                const statusSelect = document.getElementById('history-detailed-status');
                
                if (!animalSelect || !periodSelect || !statusSelect) return;
                
                const selectedAnimal = animalSelect.value;
                const selectedPeriod = periodSelect.value;
                const selectedStatus = statusSelect.value;
                
                // Calcula as datas com base no per√≠odo
                const today = new Date();
                let startDate = new Date(today);
                
                switch(selectedPeriod) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'yesterday':
                        startDate.setDate(today.getDate() - 1);
                        startDate.setHours(0, 0, 0, 0);
                        const yesterdayEnd = new Date(today);
                        yesterdayEnd.setDate(today.getDate() - 1);
                        yesterdayEnd.setHours(23, 59, 59, 999);
                        today.setTime(yesterdayEnd.getTime());
                        break;
                    case 'week':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(today.getMonth() - 1);
                        break;
                    case 'last30':
                        startDate.setDate(today.getDate() - 30);
                        break;
                }
                
                // Obt√©m o hist√≥rico filtrado
                const allHistory = this.getFilteredHistory(
                    selectedAnimal === 'all' ? 'all' : selectedAnimal,
                    'all',
                    startDate,
                    today
                );
                
                // Filtra por status
                let filteredHistory = allHistory;
                if (selectedStatus !== 'all') {
                    filteredHistory = allHistory.filter(record => {
                        if (selectedStatus === 'administered') {
                            return record.type === 'administered';
                        } else if (selectedStatus === 'pending') {
                            return record.type === 'pending';
                        } else if (selectedStatus === 'late') {
                            return record.type === 'late';
                        } else if (selectedStatus === 'on-time') {
                            return record.type === 'administered' && record.delay <= 0;
                        }
                        return true;
                    });
                }
                
                // Agrupa por data
                const groupedByDate = {};
                filteredHistory.forEach(record => {
                    const dateKey = record.date;
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(record);
                });
                
                // Ordena as datas (mais recente primeiro)
                const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                    return new Date(b) - new Date(a);
                });
                
                // Renderiza
                container.innerHTML = '';
                
                if (sortedDates.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: var(--light); border-radius: 10px; border: 1px solid var(--border-color);">
                            <h3>Nenhum registro encontrado</h3>
                            <p>Nenhum registro corresponde aos filtros selecionados.</p>
                        </div>
                    `;
                    return;
                }
                
                sortedDates.forEach(dateKey => {
                    const date = new Date(dateKey);
                    const formattedDate = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                    
                    const dateSection = document.createElement('div');
                    dateSection.className = 'history-detail-row';
                    dateSection.style.marginBottom = '20px';
                    
                    let dateHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color);">
                            <h3 style="margin: 0;">${formattedDate}</h3>
                            <span style="font-size: 0.9rem; color: var(--text-color); opacity: 0.8;">
                                ${groupedByDate[dateKey].length} registro(s)
                            </span>
                        </div>
                    `;
                    
                    groupedByDate[dateKey].forEach(record => {
                        let statusText = '';
                        let timeText = '';
                        let details = '';
                        
                        if (record.type === 'administered') {
                            const adminTime = new Date(record.timestamp);
                            const adminTimeStr = adminTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            
                            if (record.delay > 0) {
                                statusText = `<span class="history-status-badge badge-late" style="margin-left: 10px;">Atrasado (+${record.delay} min)</span>`;
                            } else if (record.delay < 0) {
                                statusText = `<span class="history-status-badge badge-on-time" style="margin-left: 10px;">Antecipado (${Math.abs(record.delay)} min antes)</span>`;
                            } else {
                                statusText = `<span class="history-status-badge badge-on-time" style="margin-left: 10px;">No hor√°rio</span>`;
                            }
                            
                            timeText = `
                                <div><span class="detail-label">Hor√°rio previsto:</span> ${record.timeOfDay === 'morning' ? 'Manh√£ (07:30)' : 'Noite (19:30)'}</div>
                                <div><span class="detail-label">Hor√°rio real:</span> ${adminTimeStr}</div>
                            `;
                            
                            details = `
                                <div><span class="detail-label">Administrado em:</span> ${adminTime.toLocaleString('pt-BR')}</div>
                            `;
                        } else if (record.type === 'late') {
                            statusText = `<span class="history-status-badge badge-late" style="margin-left: 10px;">Atrasado (+${record.delay} min)</span>`;
                            timeText = `<div><span class="detail-label">Hor√°rio previsto:</span> ${record.timeOfDay === 'morning' ? 'Manh√£ (07:30)' : 'Noite (19:30)'}</div>`;
                            details = `<div><span class="detail-label">Status:</span> N√£o administrado</div>`;
                        } else if (record.type === 'pending') {
                            statusText = `<span class="history-status-badge badge-pending" style="margin-left: 10px;">Pendente</span>`;
                            timeText = `<div><span class="detail-label">Hor√°rio previsto:</span> ${record.timeOfDay === 'morning' ? 'Manh√£ (07:30)' : 'Noite (19:30)'}</div>`;
                            details = `<div><span class="detail-label">Status:</span> Aguardando administra√ß√£o</div>`;
                        }
                        
                        dateHTML += `
                            <div style="background: var(--card-color); padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div>
                                        <strong>${record.animalIcon} ${record.animalName}</strong>
                                        <div style="font-size: 0.9rem; margin-top: 2px;">${record.medicationName} - ${record.dosage}</div>
                                    </div>
                                    ${statusText}
                                </div>
                                ${timeText}
                                ${details}
                                ${record.notes ? `<div class="history-note"><span class="detail-label">Observa√ß√µes:</span> ${record.notes}</div>` : ''}
                                <div style="margin-top: 10px; display: flex; gap: 5px;">
                                    ${record.type !== 'administered' ? `
                                        <button class="btn btn-mark btn-small" onclick="vetSystem.markPendingMedication('${record.animalName}', '${record.medicationName}', '${record.date}', '${record.timeOfDay}')">
                                            <i class="fas fa-check"></i> Marcar como Administrado
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-edit btn-small" onclick="vetSystem.viewHistoryDetails('${record.animalName}', '${record.medicationName}', '${record.timestamp || ''}')">
                                        <i class="fas fa-eye"></i> Detalhes
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    dateSection.innerHTML = dateHTML;
                    container.appendChild(dateSection);
                });
            }
            
            populateHistoryFilters() {
                const animalSelect = document.getElementById('history-animal-select');
                const medicationSelect = document.getElementById('history-medication-select');
                const animalSpecificSelect = document.getElementById('history-animal-specific-select');
                const medicationSpecificSelect = document.getElementById('history-medication-specific-select');
                const detailedAnimalSelect = document.getElementById('history-detailed-animal');
                const exportAnimalSelect = document.getElementById('export-animal-select');
                
                // Limpa e preenche todos os selects
                const populateSelect = (selectElement, defaultValue, includeAllOption = true) => {
                    if (!selectElement) return;
                    
                    selectElement.innerHTML = '';
                    
                    if (includeAllOption) {
                        const allOption = document.createElement('option');
                        allOption.value = defaultValue;
                        allOption.textContent = defaultValue === 'all' ? 'Todos os animais' : 'Selecione...';
                        selectElement.appendChild(allOption);
                    }
                    
                    Object.values(this.animals).forEach(animal => {
                        const option = document.createElement('option');
                        option.value = animal.id;
                        option.textContent = `${animal.icon} ${animal.name}`;
                        selectElement.appendChild(option);
                    });
                };
                
                if (animalSelect) populateSelect(animalSelect, 'all');
                if (animalSpecificSelect) populateSelect(animalSpecificSelect, '', false);
                if (detailedAnimalSelect) populateSelect(detailedAnimalSelect, 'all');
                if (exportAnimalSelect) populateSelect(exportAnimalSelect, 'all');
                
                // Preenche selects de medicamentos
                const populateMedicationSelect = (selectElement, defaultValue, includeAllOption = true) => {
                    if (!selectElement) return;
                    
                    selectElement.innerHTML = '';
                    
                    if (includeAllOption) {
                        const allOption = document.createElement('option');
                        allOption.value = defaultValue;
                        allOption.textContent = defaultValue === 'all' ? 'Todos os medicamentos' : 'Selecione...';
                        selectElement.appendChild(allOption);
                    }
                    
                    const medications = new Set();
                    
                    Object.values(this.animals).forEach(animal => {
                        Object.values(animal.medications).forEach(med => {
                            medications.add(med.name);
                        });
                    });
                    
                    medications.forEach(medName => {
                        const option = document.createElement('option');
                        option.value = medName;
                        option.textContent = medName;
                        selectElement.appendChild(option);
                    });
                };
                
                if (medicationSelect) populateMedicationSelect(medicationSelect, 'all');
                if (medicationSpecificSelect) populateMedicationSelect(medicationSpecificSelect, '', false);
            }
            
            viewHistoryDetails(animalName, medicationName, timestamp) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                let content = '';
                
                if (timestamp) {
                    const date = new Date(timestamp);
                    const formattedDate = date.toLocaleDateString('pt-BR');
                    const formattedTime = date.toLocaleTimeString('pt-BR');
                    const fullDateTime = date.toLocaleString('pt-BR');
                    
                    content = `
                        <p><strong>Animal:</strong> ${animalName}</p>
                        <p><strong>Medicamento:</strong> ${medicationName}</p>
                        <p><strong>Data/Hora de Administra√ß√£o:</strong> ${fullDateTime}</p>
                        <p><strong>Data:</strong> ${formattedDate}</p>
                        <p><strong>Hora:</strong> ${formattedTime}</p>
                    `;
                } else {
                    content = `
                        <p><strong>Animal:</strong> ${animalName}</p>
                        <p><strong>Medicamento:</strong> ${medicationName}</p>
                        <p><strong>Status:</strong> Pendente ou n√£o administrado</p>
                        <p>Esta medica√ß√£o ainda n√£o foi administrada ou registrada no sistema.</p>
                    `;
                }
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Detalhes da Medica√ß√£o</h3>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div>
                            ${content}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-edit" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            renderAll() {
                this.renderAnimalCards();
                this.renderCalendar();
                this.populateAnimalSelect();
                this.populateExportAnimalSelect();
                this.populateHistoryFilters();
                this.renderAnimalsManagementList();
                this.updateIndicators();
                this.updateHistoryTable();
            }
            
            renderAnimalCards() {
                const container = document.getElementById('animal-cards-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (Object.keys(this.animals).length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: var(--card-color); border-radius: 15px; border: 2px dashed var(--border-color);">
                            <h3 style="margin-bottom: 20px;">Nenhum animal cadastrado</h3>
                            <p style="margin-bottom: 20px;">Voc√™ pode adicionar animais manualmente ou carregar os dados dos seus gatos.</p>
                            <div class="controls">
                                <button class="btn btn-add" onclick="openTab(null, 'tab-animals')">
                                    <i class="fas fa-plus"></i> Adicionar Animal
                                </button>
                                <button class="btn btn-load-cats" onclick="loadFrajolaNenemData()">
                                    <i class="fas fa-cat"></i> Carregar Frajola e Nen√©m
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                Object.values(this.animals).forEach(animal => {
                    const card = document.createElement('div');
                    card.className = 'animal-card';
                    
                    let medicationsHTML = '';
                    Object.values(animal.medications).forEach(med => {
                        const status = this.getMedicationStatus(animal.id, med.id);
                        const statusText = this.getStatusText(animal.id, med.id);
                        const isOverdue = this.isMedicationOverdue(animal.id, med.id);
                        
                        medicationsHTML += `
                            <div class="medication-item ${isOverdue ? 'medication-overdue' : ''}">
                                <div class="medication-info">
                                    <h4>${med.name}</h4>
                                    <div class="medication-details">${med.dosage} - ${this.getFrequencyText(med.frequency)}</div>
                                    ${isOverdue ? '<div class="medication-details" style="color: var(--warning);"><i class="fas fa-exclamation-triangle"></i> Atrasado</div>' : ''}
                                </div>
                                <div class="medication-actions">
                                    <div class="medication-status ${status} ${isOverdue ? 'status-overdue' : ''}">${statusText}</div>
                                    ${med.schedule === 'both' ? `
                                        <button class="btn btn-mark btn-small" onclick="vetSystem.toggleMedication('${animal.id}', '${med.id}', 'morning')">
                                            <i class="fas fa-sun"></i>
                                        </button>
                                        <button class="btn btn-mark btn-small" onclick="vetSystem.toggleMedication('${animal.id}', '${med.id}', 'night')">
                                            <i class="fas fa-moon"></i>
                                        </button>
                                    ` : `
                                        <button class="btn btn-mark btn-small" onclick="vetSystem.toggleMedication('${animal.id}', '${med.id}', '${med.schedule}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    `}
                                    <button class="btn btn-unmark btn-small" onclick="vetSystem.unmarkMedication('${animal.id}', '${med.id}')">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                    <button class="btn btn-edit btn-small" onclick="vetSystem.editMedication('${animal.id}', '${med.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    card.innerHTML = `
                        <div class="animal-header">
                            <div class="animal-icon">${animal.icon}</div>
                            <div>
                                <div class="animal-name">${animal.name}</div>
                                <span class="animal-weight">${animal.weight} ‚Ä¢ ${animal.breed || 'Ra√ßa n√£o informada'}</span>
                            </div>
                            <div style="margin-left: auto;">
                                <button class="btn btn-edit btn-small" onclick="vetSystem.editAnimal('${animal.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-pdf btn-small" onclick="vetSystem.exportAnimalPDF('${animal.id}')">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                            </div>
                        </div>
                        <div class="medication-list">
                            ${medicationsHTML || '<p style="text-align: center; color: var(--text-color); opacity: 0.7;">Nenhum medicamento cadastrado</p>'}
                        </div>
                        <div class="controls">
                            <button class="btn btn-add btn-small" onclick="vetSystem.openAddMedicationModal('${animal.id}')">
                                <i class="fas fa-plus"></i> Adicionar Medicamento
                            </button>
                            <button class="btn btn-mark" onclick="vetSystem.markAll('${animal.id}', 'morning')">
                                <i class="fas fa-sun"></i> Marcar Manh√£
                            </button>
                            <button class="btn btn-mark" onclick="vetSystem.markAll('${animal.id}', 'night')">
                                <i class="fas fa-moon"></i> Marcar Noite
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            openAddMedicationModal(animalId) {
                document.getElementById('med-animal-select').value = animalId;
                openTab(null, 'tab-medications');
                document.getElementById('new-med-name').focus();
            }
            
            renderAnimalsManagementList() {
                const container = document.getElementById('animals-management-list');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.values(this.animals).forEach(animal => {
                    const item = document.createElement('div');
                    item.className = 'animal-manage-item';
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="font-size: 1.5rem;">${animal.icon}</div>
                            <div>
                                <div>${animal.name}</div>
                                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">${animal.weight} ‚Ä¢ ${animal.breed || 'Ra√ßa n√£o informada'} ‚Ä¢ ${Object.keys(animal.medications).length} medicamentos</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-edit btn-small" onclick="vetSystem.editAnimal('${animal.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="vetSystem.deleteAnimal('${animal.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            }
            
            getFrequencyText(frequency) {
                const texts = {
                    'daily': '1x ao dia',
                    '12h': '12/12h',
                    '48h': 'A cada 48h',
                    'weekly': '1x por semana',
                    'custom': 'Personalizado'
                };
                return texts[frequency] || frequency;
            }
            
            getMedicationStatus(animalId, medId) {
                const animal = this.animals[animalId];
                const med = animal.medications[medId];
                const today = this.getCurrentDate();
                const todayRecords = med.history.filter(record => 
                    record.date.startsWith(today)
                );
                
                if (med.schedule === 'both') {
                    const morningDone = todayRecords.some(r => r.timeOfDay === 'morning');
                    const nightDone = todayRecords.some(r => r.timeOfDay === 'night');
                    if (morningDone && nightDone) return 'status-done';
                    if (morningDone || nightDone) return 'status-upcoming';
                } else if (todayRecords.length > 0) {
                    return 'status-done';
                }
                return 'status-pending';
            }
            
            getStatusText(animalId, medId) {
                const animal = this.animals[animalId];
                const med = animal.medications[medId];
                const today = this.getCurrentDate();
                const todayRecords = med.history.filter(record => 
                    record.date.startsWith(today)
                );
                
                if (med.schedule === 'both') {
                    const morningDone = todayRecords.some(r => r.timeOfDay === 'morning');
                    const nightDone = todayRecords.some(r => r.timeOfDay === 'night');
                    if (morningDone && nightDone) return 'Completo';
                    if (morningDone) return 'Manh√£ OK';
                    if (nightDone) return 'Noite OK';
                } else if (todayRecords.length > 0) {
                    return 'Administrado';
                }
                return 'Pendente';
            }
            
            isMedicationOverdue(animalId, medId) {
                const animal = this.animals[animalId];
                const med = animal.medications[medId];
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const today = this.getCurrentDate();
                
                // Hor√°rios de medica√ß√£o
                const morningDeadline = 8 * 60; // 08:00
                const nightDeadline = 21 * 60; // 21:00
                
                // Verifica se h√° registros para hoje
                const todayRecords = med.history.filter(record => 
                    record.date.startsWith(today)
                );
                
                // Para medicamentos da manh√£
                if ((med.schedule === 'morning' || med.schedule === 'both') && currentTime > morningDeadline) {
                    const morningDone = todayRecords.some(r => r.timeOfDay === 'morning');
                    if (!morningDone) return true;
                }
                
                // Para medicamentos da noite (s√≥ verifica se j√° passou das 21h)
                if ((med.schedule === 'night' || med.schedule === 'both') && currentTime > nightDeadline) {
                    const nightDone = todayRecords.some(r => r.timeOfDay === 'night');
                    if (!nightDone) return true;
                }
                
                return false;
            }
            
            toggleMedication(animalId, medId, timeOfDay) {
                const animal = this.animals[animalId];
                const med = animal.medications[medId];
                const today = this.getCurrentDate();
                const recordKey = med.schedule === 'both' ? `${today}_${timeOfDay}` : today;
                
                const existingIndex = med.history.findIndex(record => 
                    record.date === recordKey
                );
                
                if (existingIndex > -1) {
                    med.history.splice(existingIndex, 1);
                    showNotification(`${med.name} desmarcado!`, 'info');
                } else {
                    // Verifica se est√° atrasado
                    const now = new Date();
                    const isOverdue = this.checkIfMedicationIsOverdue(med, timeOfDay, now);
                    
                    med.history.push({
                        date: recordKey,
                        timeOfDay: timeOfDay,
                        administered: true,
                        timestamp: new Date().toISOString(),
                        status: isOverdue ? 'late' : 'ok',
                        notes: 'Administrado via interface principal'
                    });
                    
                    showNotification(`${med.name} marcado como administrado!`);
                }
                
                this.saveToCache();
                this.renderAll();
                this.updateUpcomingMedications();
                this.updateIndicators();
                this.updateHistoryTable();
            }
            
            checkIfMedicationIsOverdue(med, timeOfDay, now) {
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                // Define o hor√°rio limite para cada per√≠odo
                const morningDeadline = 8 * 60; // 08:00
                const nightDeadline = 21 * 60; // 21:00
                
                // Verifica se est√° atrasado com base no hor√°rio atual e no per√≠odo
                if (timeOfDay === 'morning' && currentTime > morningDeadline) {
                    return true;
                } else if (timeOfDay === 'night' && currentTime > nightDeadline) {
                    return true;
                }
                
                return false;
            }
            
            unmarkMedication(animalId, medId) {
                const animal = this.animals[animalId];
                const med = animal.medications[medId];
                const today = this.getCurrentDate();
                
                med.history = med.history.filter(record => 
                    !record.date.startsWith(today)
                );
                
                this.saveToCache();
                this.renderAll();
                this.updateUpcomingMedications();
                this.updateIndicators();
                this.updateHistoryTable();
                showNotification(`${med.name} desmarcado!`, 'info');
            }
            
            markAll(animalId, timeOfDay) {
                const animal = this.animals[animalId];
                const today = this.getCurrentDate();
                let count = 0;
                
                Object.keys(animal.medications).forEach(medId => {
                    const med = animal.medications[medId];
                    
                    if (med.schedule === timeOfDay || med.schedule === 'both' || 
                        (timeOfDay === 'morning' && med.schedule === 'morning') ||
                        (timeOfDay === 'night' && med.schedule === 'night')) {
                        
                        const recordKey = med.schedule === 'both' ? 
                            `${today}_${timeOfDay}` : today;
                        
                        // Remove registro existente se houver
                        med.history = med.history.filter(record => 
                            record.date !== recordKey
                        );
                        
                        // Verifica se est√° atrasado
                        const now = new Date();
                        const isOverdue = this.checkIfMedicationIsOverdue(med, timeOfDay, now);
                        
                        // Adiciona novo registro
                        med.history.push({
                            date: recordKey,
                            timeOfDay: timeOfDay,
                            administered: true,
                            timestamp: new Date().toISOString(),
                            status: isOverdue ? 'late' : 'ok',
                            notes: 'Administrado em massa'
                        });
                        
                        count++;
                    }
                });
                
                this.saveToCache();
                this.renderAll();
                this.updateUpcomingMedications();
                this.updateIndicators();
                this.updateHistoryTable();
                showNotification(`${count} medica√ß√£o(√µes) de ${timeOfDay === 'morning' ? 'manh√£' : 'noite'} marcadas!`);
            }
            
            renderCalendar() {
                this.renderCalendarHeaders();
                this.renderCalendarDays();
            }
            
            renderCalendarHeaders() {
                const headerContainer = document.getElementById('calendar-days-header');
                if (!headerContainer) return;
                
                headerContainer.innerHTML = '';
                const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                weekdays.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'calendar-day-header';
                    dayHeader.textContent = day;
                    headerContainer.appendChild(dayHeader);
                });
            }
            
            renderCalendarDays() {
                const daysContainer = document.getElementById('calendar-days');
                if (!daysContainer) return;
                
                daysContainer.innerHTML = '';
                
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDay = firstDay.getDay();
                
                // Dias em branco no in√≠cio
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day';
                    daysContainer.appendChild(emptyDay);
                }
                
                // Dias do m√™s
                const today = new Date();
                const isCurrentMonth = today.getMonth() === this.calendarMonth && 
                                      today.getFullYear() === this.calendarYear;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    if (isCurrentMonth && day === today.getDate()) {
                        dayElement.classList.add('today');
                    }
                    
                    const dateStr = `${this.calendarYear}-${String(this.calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    dayElement.setAttribute('data-date', dateStr);
                    dayElement.onclick = () => this.openDayModal(dateStr);
                    
                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.innerHTML = `
                        <span>${day}</span>
                        <button class="day-pdf-btn" onclick="event.stopPropagation(); vetSystem.exportDayToPDF('${dateStr}')" title="Exportar PDF do dia">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    `;
                    dayElement.appendChild(dayNumber);
                    
                    // Adiciona medica√ß√µes deste dia
                    this.addMedicationsToDay(dayElement, dateStr);
                    
                    daysContainer.appendChild(dayElement);
                }
                
                // Atualiza t√≠tulo do m√™s
                const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                                  'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const currentMonthElement = document.getElementById('current-month');
                if (currentMonthElement) {
                    currentMonthElement.textContent = 
                        `${monthNames[this.calendarMonth]} ${this.calendarYear}`;
                }
            }
            
            addMedicationsToDay(dayElement, dateStr) {
                const dayMedications = [];
                const now = new Date();
                const today = this.getCurrentDate();
                const isToday = dateStr === today;
                const currentTime = now.getHours() * 60 + now.getMinutes();
                
                Object.values(this.animals).forEach(animal => {
                    Object.values(animal.medications).forEach(med => {
                        const isScheduled = med.scheduledDates.some(scheduledDate => {
                            if (scheduledDate.includes('_')) {
                                return scheduledDate.startsWith(dateStr);
                            }
                            return scheduledDate === dateStr;
                        });
                        
                        if (isScheduled) {
                            const historyRecord = med.history.find(record => 
                                record.date.startsWith(dateStr)
                            );
                            
                            if (med.schedule === 'both') {
                                // Manh√£
                                let isOverdueMorning = false;
                                if (isToday && currentTime > 8 * 60) {
                                    const morningDone = historyRecord && historyRecord.timeOfDay === 'morning';
                                    if (!morningDone) isOverdueMorning = true;
                                }
                                
                                dayMedications.push({
                                    animal: animal.name,
                                    animalIcon: animal.icon,
                                    medication: med.name,
                                    dosage: med.dosage,
                                    timeOfDay: 'morning',
                                    administered: historyRecord && historyRecord.timeOfDay === 'morning',
                                    overdue: isOverdueMorning
                                });
                                
                                // Noite
                                let isOverdueNight = false;
                                if (isToday && currentTime > 21 * 60) {
                                    const nightDone = historyRecord && historyRecord.timeOfDay === 'night';
                                    if (!nightDone) isOverdueNight = true;
                                }
                                
                                dayMedications.push({
                                    animal: animal.name,
                                    animalIcon: animal.icon,
                                    medication: med.name,
                                    dosage: med.dosage,
                                    timeOfDay: 'night',
                                    administered: historyRecord && historyRecord.timeOfDay === 'night',
                                    overdue: isOverdueNight
                                });
                            } else {
                                let isOverdue = false;
                                if (isToday) {
                                    const deadline = med.schedule === 'morning' ? 8 * 60 : 21 * 60;
                                    if (currentTime > deadline && !historyRecord) {
                                        isOverdue = true;
                                    }
                                }
                                
                                dayMedications.push({
                                    animal: animal.name,
                                    animalIcon: animal.icon,
                                    medication: med.name,
                                    dosage: med.dosage,
                                    timeOfDay: med.schedule,
                                    administered: !!historyRecord,
                                    overdue: isOverdue
                                });
                            }
                        }
                    });
                });
                
                // Agrupa por animal
                const groupedByAnimal = {};
                dayMedications.forEach(med => {
                    if (!groupedByAnimal[med.animal]) {
                        groupedByAnimal[med.animal] = [];
                    }
                    groupedByAnimal[med.animal].push(med);
                });
                
                // Adiciona ao calend√°rio (m√°ximo 4 medica√ß√µes por dia)
                let medCount = 0;
                for (const animalName in groupedByAnimal) {
                    if (medCount >= 4) break;
                    
                    const animalMeds = groupedByAnimal[animalName];
                    const animalIcon = animalMeds[0].animalIcon;
                    
                    animalMeds.forEach(med => {
                        if (medCount >= 4) return;
                        
                        const medElement = document.createElement('div');
                        const className = med.overdue ? 'calendar-medication medication-overdue' : 
                                          `calendar-medication medication-${med.timeOfDay}`;
                        medElement.className = className;
                        
                        // Tooltip com informa√ß√µes detalhadas
                        const timeText = med.timeOfDay === 'morning' ? 'Manh√£ (07:30-08:00)' : 'Noite (19:30-21:00)';
                        const statusText = med.administered ? '‚úÖ Administrado' : 
                                         med.overdue ? '‚ö†Ô∏è Atrasado' : '‚è∞ Pendente';
                        medElement.setAttribute('data-tooltip', 
                            `${animalIcon} ${animalName}\nüíä ${med.medication}\nüìã ${med.dosage}\n‚è∞ ${timeText}\n${statusText}`);
                        
                        const statusIcon = med.administered ? '‚úÖ' : (med.overdue ? '‚ö†Ô∏è' : '‚è∞');
                        medElement.textContent = `${animalIcon} ${statusIcon} ${med.medication.substring(0, 10)}`;
                        
                        dayElement.appendChild(medElement);
                        medCount++;
                    });
                }
                
                // Se houver mais medica√ß√µes, mostra indicador
                if (dayMedications.length > 4) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'calendar-medication';
                    moreElement.textContent = `+${dayMedications.length - 4} mais`;
                    moreElement.style.fontSize = '0.6rem';
                    moreElement.style.opacity = '0.7';
                    dayElement.appendChild(moreElement);
                }
            }
            
            openDayModal(dateStr) {
                this.selectedDay = dateStr;
                const modal = document.getElementById('dayModal');
                if (!modal) return;
                
                const date = new Date(dateStr);
                const modalTitle = document.getElementById('modalDayTitle');
                if (modalTitle) {
                    modalTitle.textContent = 
                        `Medica√ß√µes para ${date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
                }
                
                const dayMedications = [];
                Object.values(this.animals).forEach(animal => {
                    Object.values(animal.medications).forEach(med => {
                        const isScheduled = med.scheduledDates.some(scheduledDate => {
                            if (scheduledDate.includes('_')) {
                                return scheduledDate.startsWith(dateStr);
                            }
                            return scheduledDate === dateStr;
                        });
                        
                        if (isScheduled) {
                            const historyRecord = med.history.find(record => 
                                record.date.startsWith(dateStr)
                            );
                            
                            dayMedications.push({
                                animalId: animal.id,
                                animal: animal.name,
                                animalIcon: animal.icon,
                                medication: med.name,
                                medicationId: med.id,
                                dosage: med.dosage,
                                frequency: med.frequency,
                                timeOfDay: med.schedule,
                                administered: !!historyRecord,
                                history: med.history.filter(record => record.date.startsWith(dateStr))
                            });
                        }
                    });
                });
                
                const modalContent = document.getElementById('modalDayContent');
                if (!modalContent) return;
                
                modalContent.innerHTML = '';
                
                if (dayMedications.length === 0) {
                    modalContent.innerHTML = '<p class="text-center">Nenhuma medica√ß√£o agendada para este dia.</p>';
                } else {
                    // Tabela para mostrar medicamentos
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.innerHTML = `
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Animal</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Medica√ß√£o</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Dosagem</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Hor√°rio</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">Status</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--border-color);">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="modalDayTableBody">
                        </tbody>
                    `;
                    modalContent.appendChild(table);
                    
                    const tbody = document.getElementById('modalDayTableBody');
                    
                    dayMedications.forEach(med => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid var(--border-color)';
                        
                        let actionsHTML = '';
                        if (med.timeOfDay === 'both') {
                            const morningDone = med.history.some(h => h.timeOfDay === 'morning');
                            const nightDone = med.history.some(h => h.timeOfDay === 'night');
                            
                            actionsHTML = `
                                <button class="btn btn-mark btn-small" onclick="vetSystem.toggleMedicationFromModal('${dateStr}', '${med.animalId}', '${med.medicationId}', 'morning')" ${morningDone ? 'disabled' : ''}>
                                    <i class="fas fa-sun"></i> Manh√£
                                </button>
                                <button class="btn btn-mark btn-small" onclick="vetSystem.toggleMedicationFromModal('${dateStr}', '${med.animalId}', '${med.medicationId}', 'night')" ${nightDone ? 'disabled' : ''}>
                                    <i class="fas fa-moon"></i> Noite
                                </button>
                            `;
                        } else {
                            actionsHTML = `
                                <button class="btn btn-mark btn-small" onclick="vetSystem.toggleMedicationFromModal('${dateStr}', '${med.animalId}', '${med.medicationId}', '${med.timeOfDay}')" ${med.administered ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i> Marcar
                                </button>
                            `;
                        }
                        
                        row.innerHTML = `
                            <td style="padding: 10px;">${med.animalIcon} ${med.animal}</td>
                            <td style="padding: 10px;">${med.medication}</td>
                            <td style="padding: 10px;">${med.dosage}</td>
                            <td style="padding: 10px;">${med.timeOfDay === 'morning' ? 'Manh√£' : med.timeOfDay === 'night' ? 'Noite' : 'Manh√£ e Noite'}</td>
                            <td style="padding: 10px;">
                                <span class="medication-status ${med.administered ? 'status-done' : 'status-pending'}">
                                    ${med.administered ? 'Administrado' : 'Pendente'}
                                </span>
                            </td>
                            <td style="padding: 10px;">
                                <div style="display: flex; gap: 5px;">
                                    ${actionsHTML}
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                modal.style.display = 'flex';
            }
            
            toggleMedicationFromModal(dateStr, animalId, medicationId, timeOfDay) {
                const animal = this.animals[animalId];
                const med = animal.medications[medicationId];
                const recordKey = med.schedule === 'both' ? `${dateStr}_${timeOfDay}` : dateStr;
                
                const existingIndex = med.history.findIndex(record => 
                    record.date === recordKey
                );
                
                if (existingIndex > -1) {
                    med.history.splice(existingIndex, 1);
                    showNotification(`${med.name} desmarcado!`, 'info');
                } else {
                    // Verifica se est√° atrasado
                    const now = new Date();
                    const isOverdue = this.checkIfMedicationIsOverdue(med, timeOfDay, now);
                    
                    med.history.push({
                        date: recordKey,
                        timeOfDay: timeOfDay,
                        administered: true,
                        timestamp: new Date().toISOString(),
                        status: isOverdue ? 'late' : 'ok'
                    });
                    showNotification(`${med.name} marcado como administrado!`);
                }
                
                this.saveToCache();
                this.openDayModal(dateStr);
                this.renderAll();
                this.updateUpcomingMedications();
                this.updateIndicators();
                this.updateHistoryTable();
            }
            
            closeDayModal() {
                const modal = document.getElementById('dayModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            openExportModal() {
                const modal = document.getElementById('exportModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }
            
            closeExportModal() {
                const modal = document.getElementById('exportModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            changeMonth(delta) {
                this.calendarMonth += delta;
                
                if (this.calendarMonth > 11) {
                    this.calendarMonth = 0;
                    this.calendarYear++;
                } else if (this.calendarMonth < 0) {
                    this.calendarMonth = 11;
                    this.calendarYear--;
                }
                
                this.renderCalendar();
            }
            
            populateAnimalSelect() {
                const select = document.getElementById('med-animal-select');
                if (!select) return;
                
                select.innerHTML = '';
                
                Object.values(this.animals).forEach(animal => {
                    const option = document.createElement('option');
                    option.value = animal.id;
                    option.textContent = `${animal.icon} ${animal.name} (${animal.weight})`;
                    select.appendChild(option);
                });
            }
            
            populateExportAnimalSelect() {
                const select = document.getElementById('export-animal-select');
                if (!select) return;
                
                select.innerHTML = '<option value="all">Todos os animais</option>';
                
                Object.values(this.animals).forEach(animal => {
                    const option = document.createElement('option');
                    option.value = animal.id;
                    option.textContent = `${animal.icon} ${animal.name}`;
                    select.appendChild(option);
                });
            }
            
            addNewAnimal() {
                const nameInput = document.getElementById('new-animal-name');
                const weightInput = document.getElementById('new-animal-weight');
                const breedInput = document.getElementById('new-animal-breed');
                const iconSelect = document.getElementById('new-animal-icon');
                
                if (!nameInput || !weightInput || !breedInput || !iconSelect) return;
                
                const name = nameInput.value.trim();
                const weight = weightInput.value;
                const breed = breedInput.value.trim();
                const icon = iconSelect.value;
                
                // Valida√ß√£o
                if (!name) {
                    showNotification('Por favor, informe o nome do animal!', 'warning');
                    nameInput.classList.add('input-error');
                    return;
                }
                
                if (!weight || parseFloat(weight) <= 0) {
                    showNotification('Por favor, informe um peso v√°lido (maior que 0)!', 'warning');
                    weightInput.classList.add('input-error');
                    return;
                }
                
                const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                if (this.animals[id]) {
                    showNotification('J√° existe um animal com este nome!', 'warning');
                    return;
                }
                
                this.animals[id] = {
                    id,
                    name,
                    weight: `${parseFloat(weight).toLocaleString('pt-BR')} kg`,
                    breed: breed || 'SRD',
                    icon,
                    medications: {}
                };
                
                this.saveToCache();
                this.populateAnimalSelect();
                this.populateExportAnimalSelect();
                this.populateHistoryFilters();
                this.renderAll();
                
                // Limpa campos
                nameInput.value = '';
                weightInput.value = '';
                breedInput.value = '';
                nameInput.classList.remove('input-error');
                weightInput.classList.remove('input-error');
                
                showNotification(`${name} adicionado com sucesso!`);
            }
            
            deleteAnimal(animalId) {
                if (confirm(`Tem certeza que deseja excluir o animal ${this.animals[animalId].name}? Todos os medicamentos tamb√©m ser√£o exclu√≠dos.`)) {
                    delete this.animals[animalId];
                    this.saveToCache();
                    this.populateAnimalSelect();
                    this.populateExportAnimalSelect();
                    this.populateHistoryFilters();
                    this.renderAll();
                    showNotification('Animal exclu√≠do com sucesso!', 'info');
                }
            }
            
            editAnimal(animalId) {
                const animal = this.animals[animalId];
                if (!animal) return;
                
                const newName = prompt('Novo nome do animal:', animal.name);
                if (newName && newName.trim()) {
                    const newWeight = prompt('Novo peso (kg):', animal.weight.replace(' kg', ''));
                    const newBreed = prompt('Nova ra√ßa:', animal.breed || 'SRD');
                    
                    if (newWeight && parseFloat(newWeight) > 0) {
                        // Atualiza o ID se o nome mudou
                        const newId = newName.toLowerCase().replace(/[^a-z0-9]/g, '');
                        
                        if (newId !== animalId && this.animals[newId]) {
                            showNotification('J√° existe um animal com este nome!', 'warning');
                            return;
                        }
                        
                        // Remove o animal antigo e adiciona com novo ID
                        delete this.animals[animalId];
                        
                        this.animals[newId] = {
                            id: newId,
                            name: newName.trim(),
                            weight: `${parseFloat(newWeight).toLocaleString('pt-BR')} kg`,
                            breed: newBreed || 'SRD',
                            icon: animal.icon,
                            medications: animal.medications
                        };
                        
                        this.saveToCache();
                        this.populateAnimalSelect();
                        this.populateExportAnimalSelect();
                        this.populateHistoryFilters();
                        this.renderAll();
                        showNotification('Animal atualizado com sucesso!');
                    }
                }
            }
            
            editMedication(animalId, medicationId) {
                const animal = this.animals[animalId];
                const med = animal.medications[medicationId];
                if (!animal || !med) return;
                
                const newName = prompt('Novo nome do medicamento:', med.name);
                if (newName && newName.trim()) {
                    const newDosage = prompt('Nova dosagem:', med.dosage);
                    
                    if (newDosage && newDosage.trim()) {
                        med.name = newName.trim();
                        med.dosage = newDosage.trim();
                        
                        this.saveToCache();
                        this.renderAll();
                        showNotification('Medicamento atualizado com sucesso!');
                    }
                }
            }
            
            addNewMedication() {
                const animalId = document.getElementById('med-animal-select').value;
                const name = document.getElementById('new-med-name').value.trim();
                const dosage = document.getElementById('new-med-dosage').value.trim();
                const frequency = document.getElementById('new-med-frequency').value;
                const schedule = document.getElementById('new-med-schedule').value;
                const startDate = document.getElementById('new-med-start-date').value;
                const durationType = document.getElementById('new-med-duration-type').value;
                
                // Valida√ß√£o
                if (!animalId) {
                    showNotification('Por favor, selecione um animal!', 'warning');
                    return;
                }
                
                if (!name) {
                    showNotification('Por favor, informe o nome do medicamento!', 'warning');
                    document.getElementById('new-med-name').classList.add('input-error');
                    return;
                }
                
                if (!dosage) {
                    showNotification('Por favor, informe a dosagem!', 'warning');
                    document.getElementById('new-med-dosage').classList.add('input-error');
                    return;
                }
                
                if (!startDate) {
                    showNotification('Por favor, informe a data de in√≠cio!', 'warning');
                    return;
                }
                
                const animal = this.animals[animalId];
                if (!animal) {
                    showNotification('Animal n√£o encontrado!', 'warning');
                    return;
                }
                
                let duration = null;
                let endDate = null;
                let customHours = 24;
                
                if (frequency === 'custom') {
                    customHours = parseInt(document.getElementById('custom-frequency-value').value) || 24;
                    if (customHours < 1 || customHours > 720) {
                        showNotification('Intervalo personalizado deve estar entre 1 e 720 horas!', 'warning');
                        return;
                    }
                }
                
                if (durationType === 'days') {
                    duration = parseInt(document.getElementById('new-med-duration-days').value) || 7;
                    if (duration < 1 || duration > 365) {
                        showNotification('Dura√ß√£o deve estar entre 1 e 365 dias!', 'warning');
                        return;
                    }
                } else if (durationType === 'end_date') {
                    endDate = document.getElementById('new-med-end-date').value;
                    if (!endDate) {
                        showNotification('Por favor, informe a data de t√©rmino!', 'warning');
                        return;
                    }
                }
                
                const medId = name.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now().toString().slice(-6);
                
                const scheduledDates = this.generateScheduledDates(frequency, startDate, duration || endDate, durationType, customHours);
                
                animal.medications[medId] = {
                    id: medId,
                    name,
                    dosage,
                    frequency,
                    schedule,
                    startDate,
                    duration: durationType === 'days' ? duration : null,
                    durationType,
                    endDate: durationType === 'end_date' ? endDate : null,
                    customHours: frequency === 'custom' ? customHours : null,
                    history: [],
                    scheduledDates
                };
                
                this.saveToCache();
                
                // Limpa campos
                document.getElementById('new-med-name').value = '';
                document.getElementById('new-med-dosage').value = '';
                document.getElementById('new-med-name').classList.remove('input-error');
                document.getElementById('new-med-dosage').classList.remove('input-error');
                
                showNotification(`${name} adicionado para ${animal.name}!`);
                
                this.renderAll();
            }
            
            loadMedicationFromCache() {
                if (!this.medicationsData || !this.medicationsData.medications) {
                    showNotification('Nenhum dado de medicamentos em cache. Carregue primeiro os exemplos.', 'warning');
                    return;
                }
                
                const animalId = document.getElementById('med-animal-select').value;
                if (!animalId) {
                    showNotification('Selecione um animal primeiro!', 'warning');
                    return;
                }
                
                const animal = this.animals[animalId];
                if (!animal) {
                    showNotification('Animal n√£o encontrado!', 'warning');
                    return;
                }
                
                // Cria um modal para selecionar medicamentos do cache
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                
                let optionsHTML = '';
                Object.values(this.medicationsData.medications).forEach(med => {
                    optionsHTML += `
                        <div style="margin-bottom: 10px; padding: 10px; background: var(--light); border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${med.name}</strong>
                                    <div style="font-size: 0.85rem;">${med.common_dosage} ‚Ä¢ ${med.type}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-color); opacity: 0.7;">${med.description}</div>
                                </div>
                                <button class="btn btn-add btn-small" onclick="vetSystem.addMedicationFromCache('${animalId}', '${med.name}', '${med.common_dosage}', '${med.type}')">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Selecionar Medicamento do Cache</h3>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${optionsHTML}
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-edit" onclick="this.closest('.modal').remove()">
                                <i class="fas fa-times"></i> Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }
            
            addMedicationFromCache(animalId, name, dosage, type) {
                // Fecha o modal
                document.querySelector('.modal')?.remove();
                
                // Preenche os campos do formul√°rio
                document.getElementById('new-med-name').value = name;
                document.getElementById('new-med-dosage').value = dosage;
                
                showNotification('Medicamento carregado do cache! Preencha os outros campos e clique em Adicionar.', 'info');
            }
            
            addPreloadedMedication(animalId, name, dosage, frequency, schedule, duration) {
                if (!this.animals[animalId]) {
                    showNotification('Animal n√£o encontrado!', 'warning');
                    return;
                }
                
                const medId = name.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now().toString().slice(-6);
                const startDate = this.getCurrentDate();
                const durationType = duration ? 'days' : 'continuous';
                
                const scheduledDates = this.generateScheduledDates(frequency, startDate, duration, durationType);
                
                this.animals[animalId].medications[medId] = {
                    id: medId,
                    name,
                    dosage,
                    frequency,
                    schedule,
                    startDate,
                    duration: duration,
                    durationType: durationType,
                    history: [],
                    scheduledDates
                };
                
                this.saveToCache();
                this.renderAll();
                showNotification(`${name} adicionado para ${this.animals[animalId].name}!`);
            }
            
            loadFromCache() {
                try {
                    const cachedData = localStorage.getItem(this.cacheManager.appCacheKey);
                    
                    if (cachedData) {
                        const data = JSON.parse(cachedData);
                        this.animals = data.animals || {};
                        this.calendarMonth = data.calendarMonth || new Date().getMonth();
                        this.calendarYear = data.calendarYear || new Date().getFullYear();
                    }
                } catch (e) {
                    console.error('Erro ao carregar do cache:', e);
                }
            }
            
            saveMedicationsToCache() {
                if (this.medicationsData) {
                    if (this.cacheManager.saveMedicationsToCache(this.medicationsData)) {
                        showNotification('Medicamentos salvos em cache com sucesso!');
                    } else {
                        showNotification('Erro ao salvar medicamentos em cache!', 'danger');
                    }
                } else {
                    showNotification('Nenhum dado de medicamentos para salvar!', 'warning');
                }
            }
            
            saveToCache() {
                const data = {
                    animals: this.animals,
                    calendarMonth: this.calendarMonth,
                    calendarYear: this.calendarYear,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem(this.cacheManager.appCacheKey, JSON.stringify(data));
                    this.cacheManager.updateCacheDisplay();
                } catch (e) {
                    console.error('Erro ao salvar no cache:', e);
                    showNotification('Erro ao salvar no cache! Limite de armazenamento pode ter sido atingido.', 'danger');
                }
            }
            
            // Fun√ß√µes de exporta√ß√£o PDF
            exportDayToPDF(dateStr) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const date = new Date(dateStr || this.selectedDay);
                const title = `Medica√ß√µes para ${date.toLocaleDateString('pt-BR')}`;
                
                doc.setFontSize(18);
                doc.text(title, 14, 20);
                
                // Cria tabela
                const tableData = [];
                const dateForQuery = dateStr || this.selectedDay;
                
                Object.values(this.animals).forEach(animal => {
                    Object.values(animal.medications).forEach(med => {
                        const isScheduled = med.scheduledDates.some(scheduledDate => {
                            if (scheduledDate.includes('_')) {
                                return scheduledDate.startsWith(dateForQuery);
                            }
                            return scheduledDate === dateForQuery;
                        });
                        
                        if (isScheduled) {
                            const historyRecord = med.history.find(record => 
                                record.date.startsWith(dateForQuery)
                            );
                            
                            let scheduleText = '';
                            if (med.schedule === 'both') {
                                const morningDone = historyRecord && historyRecord.timeOfDay === 'morning';
                                const nightDone = historyRecord && historyRecord.timeOfDay === 'night';
                                scheduleText = `Manh√£: ${morningDone ? '‚úì' : '‚úó'}, Noite: ${nightDone ? '‚úì' : '‚úó'}`;
                            } else {
                                scheduleText = med.schedule === 'morning' ? 'Manh√£' : 'Noite';
                            }
                            
                            const status = historyRecord ? 
                                (historyRecord.status === 'late' ? 'Atrasado' : 'Administrado') : 
                                'Pendente';
                            
                            tableData.push([
                                animal.name,
                                med.name,
                                med.dosage,
                                scheduleText,
                                status
                            ]);
                        }
                    });
                });
                
                if (tableData.length > 0) {
                    doc.autoTable({
                        startY: 30,
                        head: [['Animal', 'Medica√ß√£o', 'Dosagem', 'Hor√°rio', 'Status']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [74, 144, 226] },
                        styles: { fontSize: 9 },
                        columnStyles: {
                            0: { cellWidth: 30 },
                            1: { cellWidth: 50 },
                            2: { cellWidth: 30 },
                            3: { cellWidth: 40 },
                            4: { cellWidth: 30 }
                        },
                        didParseCell: function(data) {
                            // Destaca atrasados em vermelho
                            if (data.column.index === 4 && data.cell.raw === 'Atrasado') {
                                data.cell.styles.fillColor = [255, 200, 200];
                                data.cell.styles.textColor = [200, 0, 0];
                            }
                        }
                    });
                } else {
                    doc.setFontSize(12);
                    doc.text('Nenhuma medica√ß√£o agendada para este dia.', 14, 40);
                }
                
                const filename = `medicacoes-${dateForQuery}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportAnimalPDF(animalId) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const animal = this.animals[animalId];
                
                doc.setFontSize(18);
                doc.text(`Registro Completo - ${animal.name}`, 14, 20);
                
                doc.setFontSize(14);
                doc.text(`Peso: ${animal.weight}`, 14, 35);
                doc.text(`Ra√ßa: ${animal.breed || 'SRD'}`, 14, 45);
                
                let y = 60;
                Object.values(animal.medications).forEach(med => {
                    doc.setFontSize(12);
                    doc.text(`‚Ä¢ ${med.name}: ${med.dosage}`, 14, y);
                    y += 7;
                    
                    doc.setFontSize(10);
                    doc.text(`  Frequ√™ncia: ${this.getFrequencyText(med.frequency)}`, 20, y);
                    y += 5;
                    doc.text(`  Hor√°rio: ${med.schedule === 'morning' ? 'Manh√£' : med.schedule === 'night' ? 'Noite' : 'Manh√£ e Noite'}`, 20, y);
                    y += 5;
                    doc.text(`  In√≠cio: ${new Date(med.startDate).toLocaleDateString('pt-BR')}`, 20, y);
                    y += 5;
                    
                    if (med.durationType === 'days' && med.duration) {
                        doc.text(`  Dura√ß√£o: ${med.duration} dias`, 20, y);
                        y += 5;
                    } else if (med.durationType === 'end_date' && med.endDate) {
                        doc.text(`  T√©rmino: ${new Date(med.endDate).toLocaleDateString('pt-BR')}`, 20, y);
                        y += 5;
                    } else if (med.durationType === 'continuous') {
                        doc.text(`  Dura√ß√£o: Cont√≠nuo`, 20, y);
                        y += 5;
                    }
                    
                    const historyCount = med.history.length;
                    const lateCount = med.history.filter(r => r.status === 'late').length;
                    doc.text(`  Registros: ${historyCount} administra√ß√µes (${lateCount} atrasadas)`, 20, y);
                    y += 10;
                    
                    if (y > 280) {
                        doc.addPage();
                        y = 20;
                    }
                });
                
                const filename = `registro-${animal.name}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportMonthToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                
                const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                                  'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const title = `Calend√°rio de Medica√ß√µes - ${monthNames[this.calendarMonth]} ${this.calendarYear}`;
                
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                
                // Gera uma tabela com todas as medica√ß√µes do m√™s
                const tableData = [];
                const firstDay = new Date(this.calendarYear, this.calendarMonth, 1);
                const lastDay = new Date(this.calendarYear, this.calendarMonth + 1, 0);
                const daysInMonth = lastDay.getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${this.calendarYear}-${String(this.calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(dateStr);
                    
                    Object.values(this.animals).forEach(animal => {
                        Object.values(animal.medications).forEach(med => {
                            const isScheduled = med.scheduledDates.some(scheduledDate => {
                                if (scheduledDate.includes('_')) {
                                    return scheduledDate.startsWith(dateStr);
                                }
                                return scheduledDate === dateStr;
                            });
                            
                            if (isScheduled) {
                                const historyRecord = med.history.find(record => 
                                    record.date.startsWith(dateStr)
                                );
                                
                                const status = historyRecord ? 
                                    (historyRecord.status === 'late' ? 'Atrasado' : 'Administrado') : 
                                    'Pendente';
                                
                                tableData.push([
                                    date.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric' }),
                                    animal.name,
                                    med.name,
                                    med.dosage,
                                    med.schedule === 'morning' ? 'Manh√£' : med.schedule === 'night' ? 'Noite' : 'Ambos',
                                    status
                                ]);
                            }
                        });
                    });
                }
                
                doc.autoTable({
                    startY: 30,
                    head: [['Data', 'Animal', 'Medica√ß√£o', 'Dosagem', 'Hor√°rio', 'Status']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [74, 144, 226] },
                    margin: { left: 10, right: 10 },
                    didParseCell: function(data) {
                        // Destaca atrasados em vermelho
                        if (data.column.index === 5 && data.cell.raw === 'Atrasado') {
                            data.cell.styles.fillColor = [255, 200, 200];
                            data.cell.styles.textColor = [200, 0, 0];
                        }
                    }
                });
                
                const filename = `calendario-${monthNames[this.calendarMonth]}-${this.calendarYear}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportMonthRangeToPDF() {
                this.openExportModal();
            }
            
            exportSelectedRangeToPDF() {
                const startDate = document.getElementById('export-start-date').value;
                const endDate = document.getElementById('export-end-date').value;
                const animalId = document.getElementById('export-animal-select').value;
                
                if (!startDate || !endDate) {
                    showNotification('Por favor, selecione as datas!', 'warning');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                const title = `Relat√≥rio de Medica√ß√µes - ${start.toLocaleDateString('pt-BR')} a ${end.toLocaleDateString('pt-BR')}`;
                
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                
                const tableData = [];
                const currentDate = new Date(start);
                
                while (currentDate <= end) {
                    const dateStr = this.formatDate(currentDate);
                    
                    const animalsToProcess = animalId === 'all' 
                        ? Object.values(this.animals) 
                        : [this.animals[animalId]].filter(Boolean);
                    
                    animalsToProcess.forEach(animal => {
                        Object.values(animal.medications).forEach(med => {
                            const isScheduled = med.scheduledDates.some(scheduledDate => {
                                if (scheduledDate.includes('_')) {
                                    return scheduledDate.startsWith(dateStr);
                                }
                                return scheduledDate === dateStr;
                            });
                            
                            if (isScheduled) {
                                const historyRecord = med.history.find(record => 
                                    record.date.startsWith(dateStr)
                                );
                                
                                const status = historyRecord ? 
                                    (historyRecord.status === 'late' ? 'Atrasado' : 'Administrado') : 
                                    'Pendente';
                                
                                tableData.push([
                                    currentDate.toLocaleDateString('pt-BR'),
                                    animal.name,
                                    med.name,
                                    med.dosage,
                                    med.schedule === 'morning' ? 'Manh√£' : med.schedule === 'night' ? 'Noite' : 'Ambos',
                                    status
                                ]);
                            }
                        });
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                if (tableData.length === 0) {
                    doc.setFontSize(12);
                    doc.text('Nenhuma medica√ß√£o encontrada no per√≠odo selecionado.', 14, 40);
                } else {
                    doc.autoTable({
                        startY: 30,
                        head: [['Data', 'Animal', 'Medica√ß√£o', 'Dosagem', 'Hor√°rio', 'Status']],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [74, 144, 226] },
                        didParseCell: function(data) {
                            // Destaca atrasados em vermelho
                            if (data.column.index === 5 && data.cell.raw === 'Atrasado') {
                                data.cell.styles.fillColor = [255, 200, 200];
                                data.cell.styles.textColor = [200, 0, 0];
                            }
                        }
                    });
                }
                
                const filename = `relatorio-${startDate}-a-${endDate}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
                this.closeExportModal();
            }
            
            exportHistoryToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const animalSelect = document.getElementById('history-animal-select');
                const medicationSelect = document.getElementById('history-medication-select');
                const periodSelect = document.getElementById('history-period-select');
                
                if (!animalSelect || !medicationSelect || !periodSelect) return;
                
                const selectedAnimal = animalSelect.value;
                const selectedMedication = medicationSelect.value;
                const selectedPeriod = periodSelect.value;
                
                const today = new Date();
                let startDate;
                
                if (selectedPeriod === 'custom') {
                    const customStartDate = document.getElementById('custom-start-date').value;
                    const customEndDate = document.getElementById('custom-end-date').value;
                    
                    if (!customStartDate || !customEndDate) {
                        showNotification('Por favor, selecione as datas para o per√≠odo personalizado!', 'warning');
                        return;
                    }
                    
                    startDate = new Date(customStartDate);
                    const endDate = new Date(customEndDate);
                    
                    // Ajusta para incluir todo o dia final
                    endDate.setHours(23, 59, 59, 999);
                    
                    const history = this.getFilteredHistory(selectedAnimal, selectedMedication, startDate, endDate);
                    this.renderHistoryPDF(doc, history, startDate, endDate);
                } else {
                    const periodDays = parseInt(selectedPeriod);
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - periodDays);
                    
                    const history = this.getFilteredHistory(selectedAnimal, selectedMedication, startDate, today);
                    this.renderHistoryPDF(doc, history, startDate, today);
                }
            }
            
            renderHistoryPDF(doc, history, startDate, endDate) {
                const title = `Hist√≥rico de Medica√ß√µes - ${startDate.toLocaleDateString('pt-BR')} a ${endDate.toLocaleDateString('pt-BR')}`;
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                
                if (history.length === 0) {
                    doc.setFontSize(12);
                    doc.text('Nenhum registro encontrado no per√≠odo selecionado.', 14, 40);
                } else {
                    const tableData = history.map(record => {
                        let formattedDate = '';
                        let formattedTime = '';
                        let status = '';
                        let delay = '';
                        
                        if (record.type === 'administered') {
                            const date = new Date(record.timestamp);
                            formattedDate = date.toLocaleDateString('pt-BR');
                            formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            
                            if (record.delay > 0) {
                                status = 'Atrasado';
                                delay = `+${record.delay} min`;
                            } else if (record.delay < 0) {
                                status = 'Antecipado';
                                delay = `${Math.abs(record.delay)} min antes`;
                            } else {
                                status = 'No prazo';
                                delay = 'No hor√°rio';
                            }
                        } else if (record.type === 'late') {
                            formattedDate = new Date(record.date).toLocaleDateString('pt-BR');
                            formattedTime = '--:--';
                            status = 'Atrasado';
                            delay = `+${record.delay} min`;
                        } else if (record.type === 'pending') {
                            formattedDate = new Date(record.date).toLocaleDateString('pt-BR');
                            formattedTime = '--:--';
                            status = 'Pendente';
                            delay = '';
                        }
                        
                        return [
                            formattedDate,
                            formattedTime,
                            record.animalName,
                            record.medicationName,
                            record.dosage,
                            record.timeOfDay === 'morning' ? 'Manh√£' : 'Noite',
                            status,
                            delay
                        ];
                    });
                    
                    doc.autoTable({
                        startY: 30,
                        head: [['Data', 'Hora', 'Animal', 'Medica√ß√£o', 'Dosagem', 'Hor√°rio', 'Status', 'Atraso']],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [74, 144, 226] },
                        didParseCell: function(data) {
                            if (data.column.index === 6 && data.cell.raw === 'Atrasado') {
                                data.cell.styles.fillColor = [255, 200, 200];
                                data.cell.styles.textColor = [200, 0, 0];
                            }
                        }
                    });
                }
                
                const filename = `historico-${startDate.toISOString().split('T')[0]}-a-${endDate.toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportAnimalHistoryPDF() {
                const animalSelect = document.getElementById('history-animal-specific-select');
                if (!animalSelect || !animalSelect.value) {
                    showNotification('Selecione um animal primeiro!', 'warning');
                    return;
                }
                
                const animal = this.animals[animalSelect.value];
                if (!animal) return;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const periodSelect = document.getElementById('history-animal-period');
                const selectedPeriod = parseInt(periodSelect.value);
                
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - selectedPeriod);
                
                const history = [];
                
                Object.values(animal.medications).forEach(med => {
                    med.history.forEach(record => {
                        const recordDate = new Date(record.timestamp);
                        if (recordDate >= startDate && recordDate <= today) {
                            // Determina o hor√°rio previsto
                            let scheduledTime = this.getScheduledTime(record.date.split('_')[0], record.timeOfDay || med.schedule);
                            let delayMinutes = null;
                            
                            if (scheduledTime) {
                                delayMinutes = Math.round((recordDate - scheduledTime) / (1000 * 60));
                            }
                            
                            history.push({
                                medicationName: med.name,
                                dosage: med.dosage,
                                timeOfDay: record.timeOfDay || med.schedule,
                                timestamp: record.timestamp,
                                status: record.status || 'ok',
                                scheduledTime: scheduledTime,
                                delay: delayMinutes
                            });
                        }
                    });
                });
                
                history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const title = `Hist√≥rico de ${animal.name} - ${startDate.toLocaleDateString('pt-BR')} a ${today.toLocaleDateString('pt-BR')}`;
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                
                doc.setFontSize(12);
                doc.text(`Peso: ${animal.weight} | Ra√ßa: ${animal.breed || 'SRD'}`, 14, 30);
                
                if (history.length === 0) {
                    doc.setFontSize(12);
                    doc.text('Nenhum registro encontrado no per√≠odo selecionado.', 14, 45);
                } else {
                    const tableData = history.map(record => {
                        const date = new Date(record.timestamp);
                        const formattedDate = date.toLocaleDateString('pt-BR');
                        const formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        
                        let status = '';
                        let delay = '';
                        
                        if (record.delay > 0) {
                            status = 'Atrasado';
                            delay = `+${record.delay} min`;
                        } else if (record.delay < 0) {
                            status = 'Antecipado';
                            delay = `${Math.abs(record.delay)} min antes`;
                        } else {
                            status = 'No prazo';
                            delay = 'No hor√°rio';
                        }
                        
                        return [
                            formattedDate,
                            formattedTime,
                            record.medicationName,
                            record.dosage,
                            record.timeOfDay === 'morning' ? 'Manh√£' : 'Noite',
                            status,
                            delay
                        ];
                    });
                    
                    doc.autoTable({
                        startY: 40,
                        head: [['Data', 'Hora', 'Medica√ß√£o', 'Dosagem', 'Hor√°rio', 'Status', 'Atraso']],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [74, 144, 226] },
                        didParseCell: function(data) {
                            if (data.column.index === 5 && data.cell.raw === 'Atrasado') {
                                data.cell.styles.fillColor = [255, 200, 200];
                                data.cell.styles.textColor = [200, 0, 0];
                            }
                        }
                    });
                }
                
                const filename = `historico-${animal.name}-${startDate.toISOString().split('T')[0]}-a-${today.toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportMedicationHistoryPDF() {
                const medicationSelect = document.getElementById('history-medication-specific-select');
                if (!medicationSelect || !medicationSelect.value) {
                    showNotification('Selecione um medicamento primeiro!', 'warning');
                    return;
                }
                
                const medicationName = medicationSelect.value;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const periodSelect = document.getElementById('history-medication-period');
                const selectedPeriod = parseInt(periodSelect.value);
                
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - selectedPeriod);
                
                const history = [];
                
                Object.values(this.animals).forEach(animal => {
                    Object.values(animal.medications).forEach(med => {
                        if (med.name === medicationName) {
                            med.history.forEach(record => {
                                const recordDate = new Date(record.timestamp);
                                if (recordDate >= startDate && recordDate <= today) {
                                    // Determina o hor√°rio previsto
                                    let scheduledTime = this.getScheduledTime(record.date.split('_')[0], record.timeOfDay || med.schedule);
                                    let delayMinutes = null;
                                    
                                    if (scheduledTime) {
                                        delayMinutes = Math.round((recordDate - scheduledTime) / (1000 * 60));
                                    }
                                    
                                    history.push({
                                        animalName: animal.name,
                                        dosage: med.dosage,
                                        timeOfDay: record.timeOfDay || med.schedule,
                                        timestamp: record.timestamp,
                                        status: record.status || 'ok',
                                        scheduledTime: scheduledTime,
                                        delay: delayMinutes
                                    });
                                }
                            });
                        }
                    });
                });
                
                history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const title = `Hist√≥rico de ${medicationName} - ${startDate.toLocaleDateString('pt-BR')} a ${today.toLocaleDateString('pt-BR')}`;
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                
                if (history.length === 0) {
                    doc.setFontSize(12);
                    doc.text('Nenhum registro encontrado no per√≠odo selecionado.', 14, 40);
                } else {
                    const tableData = history.map(record => {
                        const date = new Date(record.timestamp);
                        const formattedDate = date.toLocaleDateString('pt-BR');
                        const formattedTime = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        
                        let status = '';
                        let delay = '';
                        
                        if (record.delay > 0) {
                            status = 'Atrasado';
                            delay = `+${record.delay} min`;
                        } else if (record.delay < 0) {
                            status = 'Antecipado';
                            delay = `${Math.abs(record.delay)} min antes`;
                        } else {
                            status = 'No prazo';
                            delay = 'No hor√°rio';
                        }
                        
                        return [
                            formattedDate,
                            formattedTime,
                            record.animalName,
                            record.dosage,
                            record.timeOfDay === 'morning' ? 'Manh√£' : 'Noite',
                            status,
                            delay
                        ];
                    });
                    
                    doc.autoTable({
                        startY: 30,
                        head: [['Data', 'Hora', 'Animal', 'Dosagem', 'Hor√°rio', 'Status', 'Atraso']],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [74, 144, 226] },
                        didParseCell: function(data) {
                            if (data.column.index === 5 && data.cell.raw === 'Atrasado') {
                                data.cell.styles.fillColor = [255, 200, 200];
                                data.cell.styles.textColor = [200, 0, 0];
                            }
                        }
                    });
                }
                
                const filename = `historico-${medicationName.replace(/[^a-z0-9]/gi, '-')}-${startDate.toISOString().split('T')[0]}-a-${today.toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportDetailedHistoryPDF() {
                const animalSelect = document.getElementById('history-detailed-animal');
                const periodSelect = document.getElementById('history-detailed-period');
                const statusSelect = document.getElementById('history-detailed-status');
                
                if (!animalSelect || !periodSelect || !statusSelect) return;
                
                const selectedAnimal = animalSelect.value;
                const selectedPeriod = periodSelect.value;
                const selectedStatus = statusSelect.value;
                
                // Calcula as datas com base no per√≠odo
                const today = new Date();
                let startDate = new Date(today);
                
                switch(selectedPeriod) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'yesterday':
                        startDate.setDate(today.getDate() - 1);
                        startDate.setHours(0, 0, 0, 0);
                        const yesterdayEnd = new Date(today);
                        yesterdayEnd.setDate(today.getDate() - 1);
                        yesterdayEnd.setHours(23, 59, 59, 999);
                        today.setTime(yesterdayEnd.getTime());
                        break;
                    case 'week':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(today.getMonth() - 1);
                        break;
                    case 'last30':
                        startDate.setDate(today.getDate() - 30);
                        break;
                }
                
                // Obt√©m o hist√≥rico filtrado
                const allHistory = this.getFilteredHistory(
                    selectedAnimal === 'all' ? 'all' : selectedAnimal,
                    'all',
                    startDate,
                    today
                );
                
                // Filtra por status
                let filteredHistory = allHistory;
                if (selectedStatus !== 'all') {
                    filteredHistory = allHistory.filter(record => {
                        if (selectedStatus === 'administered') {
                            return record.type === 'administered';
                        } else if (selectedStatus === 'pending') {
                            return record.type === 'pending';
                        } else if (selectedStatus === 'late') {
                            return record.type === 'late';
                        } else if (selectedStatus === 'on-time') {
                            return record.type === 'administered' && record.delay <= 0;
                        }
                        return true;
                    });
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const title = `Relat√≥rio Detalhado - ${startDate.toLocaleDateString('pt-BR')} a ${today.toLocaleDateString('pt-BR')}`;
                doc.setFontSize(16);
                doc.text(title, 14, 20);
                
                doc.setFontSize(10);
                doc.text(`Filtros: Animal: ${selectedAnimal === 'all' ? 'Todos' : selectedAnimal}, Per√≠odo: ${selectedPeriod}, Status: ${selectedStatus}`, 14, 30);
                
                if (filteredHistory.length === 0) {
                    doc.setFontSize(12);
                    doc.text('Nenhum registro encontrado com os filtros selecionados.', 14, 45);
                } else {
                    let y = 45;
                    
                    // Agrupa por data
                    const groupedByDate = {};
                    filteredHistory.forEach(record => {
                        const dateKey = record.date;
                        if (!groupedByDate[dateKey]) {
                            groupedByDate[dateKey] = [];
                        }
                        groupedByDate[dateKey].push(record);
                    });
                    
                    // Ordena as datas (mais recente primeiro)
                    const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                        return new Date(b) - new Date(a);
                    });
                    
                    sortedDates.forEach(dateKey => {
                        const date = new Date(dateKey);
                        const formattedDate = date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        
                        doc.setFontSize(12);
                        doc.text(formattedDate, 14, y);
                        y += 7;
                        
                        groupedByDate[dateKey].forEach(record => {
                            let statusText = '';
                            let timeText = '';
                            
                            if (record.type === 'administered') {
                                const adminTime = new Date(record.timestamp);
                                const adminTimeStr = adminTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                
                                if (record.delay > 0) {
                                    statusText = ` (Atrasado: +${record.delay} min)`;
                                } else if (record.delay < 0) {
                                    statusText = ` (Antecipado: ${Math.abs(record.delay)} min antes)`;
                                } else {
                                    statusText = ` (No hor√°rio)`;
                                }
                                
                                timeText = ` - ${adminTimeStr}`;
                            } else if (record.type === 'late') {
                                statusText = ` (Atrasado: +${record.delay} min)`;
                                timeText = ' - N√£o administrado';
                            } else if (record.type === 'pending') {
                                statusText = ' (Pendente)';
                                timeText = ' - Aguardando administra√ß√£o';
                            }
                            
                            doc.setFontSize(10);
                            const line = `‚Ä¢ ${record.animalName}: ${record.medicationName} - ${record.dosage}${timeText}${statusText}`;
                            
                            // Verifica se cabe na p√°gina
                            if (y > 280) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            doc.text(line, 20, y);
                            y += 5;
                        });
                        
                        y += 5;
                        
                        // Verifica se precisa de nova p√°gina
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                    });
                }
                
                const filename = `relatorio-detalhado-${startDate.toISOString().split('T')[0]}-a-${today.toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                showNotification(`PDF exportado: ${filename}`);
            }
            
            exportAllToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text('Relat√≥rio Completo de Medica√ß√µes', 14, 20);
                
                let y = 35;
                Object.values(this.animals).forEach(animal => {
                    doc.setFontSize(14);
                    doc.text(`${animal.icon} ${animal.name} - ${animal.weight} - ${animal.breed || 'SRD'}`, 14, y);
                    y += 10;
                    
                    Object.values(animal.medications).forEach(med => {
                        doc.setFontSize(12);
                        doc.text(`‚Ä¢ ${med.name}: ${med.dosage}`, 20, y);
                        y += 7;
                        
                        doc.setFontSize(10);
                        doc.text(`  Frequ√™ncia: ${this.getFrequencyText(med.frequency)}`, 25, y);
                        y += 5;
                        doc.text(`  Hor√°rio: ${med.schedule === 'morning' ? 'Manh√£' : med.schedule === 'night' ? 'Noite' : 'Manh√£ e Noite'}`, 25, y);
                        y += 5;
                        doc.text(`  In√≠cio: ${new Date(med.startDate).toLocaleDateString('pt-BR')}`, 25, y);
                        y += 5;
                        
                        if (med.durationType === 'days' && med.duration) {
                            doc.text(`  Dura√ß√£o: ${med.duration} dias`, 25, y);
                            y += 5;
                        } else if (med.durationType === 'end_date' && med.endDate) {
                            doc.text(`  T√©rmino: ${new Date(med.endDate).toLocaleDateString('pt-BR')}`, 25, y);
                            y += 5;
                        } else if (med.durationType === 'continuous') {
                            doc.text(`  Dura√ß√£o: Cont√≠nuo`, 25, y);
                            y += 5;
                        }
                        
                        const historyCount = med.history.length;
                        const lateCount = med.history.filter(r => r.status === 'late').length;
                        doc.text(`  Registros: ${historyCount} administra√ß√µes (${lateCount} atrasadas)`, 25, y);
                        y += 10;
                        
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                    });
                    
                    y += 10;
                });
                
                doc.save('relatorio-completo-medicacoes.pdf');
                showNotification('PDF completo exportado!');
            }
            
            exportData() {
                const data = {
                    animals: this.animals,
                    exportedAt: new Date().toISOString(),
                    version: '3.0'
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `backup-medicacao-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Dados exportados com sucesso!');
            }
            
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = event => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (data.animals) {
                                this.animals = data.animals;
                                this.saveToCache();
                                this.populateAnimalSelect();
                                this.populateExportAnimalSelect();
                                this.populateHistoryFilters();
                                this.renderAll();
                                this.updateUpcomingMedications();
                                this.updateIndicators();
                                this.updateHistoryTable();
                                showNotification('Dados importados com sucesso!');
                            }
                        } catch (error) {
                            showNotification('Erro ao importar dados! Arquivo inv√°lido.', 'danger');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            }
            
            resetAllData() {
                if (confirm('ATEN√á√ÉO: Isso ir√° resetar TODOS os dados para os valores padr√£o. Tem certeza?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        // Inst√¢ncia global do sistema
        const vetSystem = new VeterinarySystem();

        // Fun√ß√µes globais
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'warning') {
                notification.style.background = 'var(--warning)';
            } else if (type === 'danger') {
                notification.style.background = 'var(--danger)';
            } else if (type === 'info') {
                notification.style.background = 'var(--info)';
            } else {
                notification.style.background = 'var(--success)';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function clearAppCache() {
            vetSystem.cacheManager.clearAppCache();
            setTimeout(() => location.reload(), 1000);
        }

        function clearMedicationsCache() {
            vetSystem.cacheManager.clearMedicationsCache();
        }

        function saveMedicationsToCache() {
            vetSystem.saveMedicationsToCache();
        }

        function loadMedicationsFromJSON() {
            vetSystem.loadMedicationsFromJSON();
        }

        function loadFrajolaNenemData() {
            vetSystem.loadFrajolaNenemData();
        }

        function loadSampleData() {
            vetSystem.loadSampleData();
        }

        function clearAllData() {
            vetSystem.clearAllData();
        }

        function closeDayModal() {
            vetSystem.closeDayModal();
        }

        function closeExportModal() {
            vetSystem.closeExportModal();
        }

        function changeMonth(delta) {
            vetSystem.changeMonth(delta);
        }

        function exportMonthToPDF() {
            vetSystem.exportMonthToPDF();
        }

        function exportMonthRangeToPDF() {
            vetSystem.exportMonthRangeToPDF();
        }

        function exportDayToPDF(dateStr) {
            vetSystem.exportDayToPDF(dateStr);
        }

        function exportAllToPDF() {
            vetSystem.exportAllToPDF();
        }

        function addNewAnimal() {
            vetSystem.addNewAnimal();
        }

        function addNewMedication() {
            vetSystem.addNewMedication();
        }

        function addPreloadedMedication(animalId, name, dosage, frequency, schedule, duration) {
            vetSystem.addPreloadedMedication(animalId, name, dosage, frequency, schedule, duration);
        }

        function exportData() {
            vetSystem.exportData();
        }

        function importData() {
            vetSystem.importData();
        }

        function resetAllData() {
            vetSystem.resetAllData();
        }

        function toggleCustomFrequency() {
            vetSystem.toggleCustomFrequency();
        }

        function toggleDurationFields() {
            vetSystem.toggleDurationFields();
        }

        function updateHistoryTable() {
            vetSystem.updateHistoryTable();
        }

        function updateAnimalHistory() {
            vetSystem.updateAnimalHistory();
        }

        function updateMedicationHistory() {
            vetSystem.updateMedicationHistory();
        }

        function updateDetailedHistory() {
            vetSystem.updateDetailedHistory();
        }

        function exportHistoryToPDF() {
            vetSystem.exportHistoryToPDF();
        }

        function exportAnimalHistoryPDF() {
            vetSystem.exportAnimalHistoryPDF();
        }

        function exportMedicationHistoryPDF() {
            vetSystem.exportMedicationHistoryPDF();
        }

        function exportDetailedHistoryPDF() {
            vetSystem.exportDetailedHistoryPDF();
        }

        function openTab(evt, tabName) {
            // Esconde todos os conte√∫dos das tabs
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove a classe active de todos os bot√µes
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Mostra a tab atual e adiciona a classe active ao bot√£o
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            if (evt) {
                evt.currentTarget.classList.add('active');
            } else {
                // Encontra o bot√£o correspondente √† tab
                for (let i = 0; i < tabButtons.length; i++) {
                    if (tabButtons[i].textContent.includes(tabName.replace('tab-', ''))) {
                        tabButtons[i].classList.add('active');
                        break;
                    }
                }
            }
            
            // Atualiza os dados da tab se for uma tab de hist√≥rico
            if (tabName === 'history-animal') {
                vetSystem.updateAnimalHistory();
            } else if (tabName === 'history-medication') {
                vetSystem.updateMedicationHistory();
            } else if (tabName === 'history-detailed') {
                vetSystem.updateDetailedHistory();
            }
        }

        function openHistoryTab(evt, tabName) {
            // Esconde todos os conte√∫dos das tabs
            const historyTabs = document.querySelectorAll('#history-all, #history-animal, #history-medication, #history-detailed');
            historyTabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove a classe active de todos os bot√µes
            const historyButtons = document.querySelectorAll('.history-section .tab-button');
            historyButtons.forEach(btn => btn.classList.remove('active'));
            
            // Mostra a tab atual e adiciona a classe active ao bot√£o
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            if (evt) {
                evt.currentTarget.classList.add('active');
            }
            
            // Atualiza os dados da tab espec√≠fica
            if (tabName === 'history-animal') {
                vetSystem.updateAnimalHistory();
            } else if (tabName === 'history-medication') {
                vetSystem.updateMedicationHistory();
            } else if (tabName === 'history-detailed') {
                vetSystem.updateDetailedHistory();
            }
        }

        // Inicializa o sistema quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            vetSystem.init();
        });
    </script>
</body>
</html>
